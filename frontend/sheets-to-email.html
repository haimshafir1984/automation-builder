<!doctype html>
<html lang="he" dir="rtl">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>××•×˜×•××¦×™×”: Google Sheets â†’ Email</title>
<style>
  :root{ --bg:#0c1222; --card:#101a31; --muted:#a9b4cc; --fg:#eaf0ff; --line:#1b2847; --accent:#5ea0ff }
  body{ margin:24px; font-family:system-ui,Segoe UI,Arial; background:var(--bg); color:var(--fg) }
  h1{ margin:0 0 16px }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.25) }
  label{ font-size:12px; color:var(--muted) }
  input,select,textarea{ width:100%; background:#0d1530; color:var(--fg); border:1px solid var(--line); border-radius:12px; padding:10px 12px; margin:6px 0 12px }
  textarea{ min-height:88px }
  button{ background:var(--accent); color:#051028; font-weight:700; border:0; border-radius:12px; padding:12px 14px; cursor:pointer }
  button:disabled{ opacity:.6; cursor:not-allowed }
  pre{ background:#0a1228; border:1px solid var(--line); border-radius:12px; padding:12px; white-space:pre-wrap; word-break:break-word }
  .row{ display:flex; gap:8px; align-items:center }
</style>
<body>
  <h1>ğŸ§© ×™×¦×™×¨×ª ××•×˜×•××¦×™×”: ×©×•×¨×” ×—×“×©×” ×‘×’×™×œ×™×•×Ÿ â†’ ×©×œ×™×—×ª ××™×™×œ</h1>

  <div class="grid">
    <div class="card">
      <h3>××§×•×¨: Google Sheets</h3>
      <label>×§×™×©×•×¨ ×œ×’×™×œ×™×•×Ÿ (××• Spreadsheet ID)</label>
      <input id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/XXXXX/edit#gid=0">

      <div class="row">
        <div style="flex:1">
          <label>×œ×©×•× ×™×ª (Sheet name)</label>
          <input id="sheetName" value="Sheet1">
        </div>
        <div style="width:130px">
          <label>×©×•×¨×ª ×›×•×ª×¨×•×ª</label>
          <input id="headerRow" type="number" value="1" min="1">
        </div>
        <div style="width:170px">
          <label>×ª×“×™×¨×•×ª ×‘×“×™×§×” (×“×§×•×ª)</label>
          <input id="interval" type="number" value="1" min="1">
        </div>
      </div>

      <h3>×ª× ××™ ×œ×¤×™ ×¢××•×“×” (××•×¤×¦×™×•× ×œ×™)</h3>
      <div class="row">
        <div style="flex:1">
          <label>×©× ×¢××•×“×”</label>
          <input id="fField" placeholder="×œ××©×œ Status ××• ×©× ×”×¢××•×“×” ××¦×œ×š">
        </div>
        <div style="width:150px">
          <label>××•×¤×¨×˜×•×¨</label>
          <select id="fOp">
            <option value="">(×œ×œ×)</option>
            <option value="not-empty">×œ× ×¨×™×§</option>
            <option value="equals">×©×•×•×”</option>
            <option value="contains">××›×™×œ</option>
          </select>
        </div>
        <div style="flex:1">
          <label>×¢×¨×š ×œ×”×©×•×•××” (×× ×¦×¨×™×š)</label>
          <input id="fValue" placeholder="×œ××©×œ New / Yes / '×œ×§×•×—×•×ª'">
        </div>
      </div>
    </div>

    <div class="card">
      <h3>×™×¢×“: Email</h3>
      <label>××œ (To)</label>
      <input id="to" placeholder="name@example.com">

      <label>× ×•×©× (Subject)</label>
      <input id="subject" placeholder="×©×•×¨×” ×—×“×©×” ×‘×’×œ×™×•×Ÿ">

      <label>×ª×•×›×Ÿ (Body)</label>
      <textarea id="body" placeholder="× ×•×¡×¤×” ×©×•×¨×” ×—×“×©×”"></textarea>

      <div class="row">
        <button id="btnPreview">×ª×¦×•×’×” ××§×“×™××” ×œ-Spec</button>
        <button id="btnCreate">×¦×•×¨ ××•×˜×•××¦×™×”</button>
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:16px;">
    <div class="card">
      <h3>Spec</h3>
      <pre id="specOut">â€”</pre>
    </div>
    <div class="card">
      <h3>×ª×•×¦××ª ×™×¦×™×¨×”</h3>
      <pre id="createOut">â€”</pre>
    </div>
  </div>

<script>
const BASE = "http://127.0.0.1:5000";
const $ = s => document.querySelector(s);
const j = o => JSON.stringify(o,null,2);

function parseSpreadsheetId(input) {
  if (!input) return "";
  // ×× ×”×“×‘×™×§×• URL ××œ× â€“ × ×—×œ×¥ ××× ×• ××ª ×”-ID
  const m = input.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  if (m && m[1]) return m[1];
  // ××—×¨×ª ×× ×–×” × ×¨××” ×›×‘×¨ ×›××• ID, × ×—×–×™×¨ ×›××• ×©×”×•×
  return input.trim();
}

function buildSpec() {
  const spreadsheetId = parseSpreadsheetId($("#sheetUrl").value);
  const sheetName = $("#sheetName").value || "Sheet1";
  const headerRow = Number($("#headerRow").value || 1);
  const intervalMinutes = Number($("#interval").value || 1);

  const to = $("#to").value;
  const subject = $("#subject").value || "×©×•×¨×” ×—×“×©×” ×‘×’×œ×™×•×Ÿ";
  const body = $("#body").value || "× ×•×¡×¤×” ×©×•×¨×” ×—×“×©×”";

  const fField = $("#fField").value.trim();
  const fOp = $("#fOp").value.trim();
  const fValue = $("#fValue").value;

  const filters = [];
  if (fField && fOp) {
    const f = { field: fField, op: fOp };
    if (fOp !== "not-empty") f.value = fValue ?? "";
    filters.push(f);
  }

  return {
    source: "google-sheets",
    trigger: "row-added",
    target: "email",
    action: "send",
    fields: {},
    filters,
    mapping: {},
    params: {
      source: { spreadsheetId, sheetName, headerRow, intervalMinutes },
      target: { to, subject, body }
    }
  };
}

$("#btnPreview").onclick = () => {
  const spec = buildSpec();
  $("#specOut").textContent = j(spec);
};

$("#btnCreate").onclick = async () => {
  const spec = buildSpec();
  if (!spec.params.source.spreadsheetId) {
    alert("×—×¡×¨ Spreadsheet ID ××• ×§×™×©×•×¨ ×œ×’×™×œ×™×•×Ÿ");
    return;
  }
  if (!spec.params.target.to) {
    alert("×—×¡×¨ ×©×“×” To ×‘××™×™×œ");
    return;
  }
  const r = await fetch(`${BASE}/api/automation`, {
    method:"POST",
    headers:{ "Content-Type":"application/json; charset=utf-8" },
    body: JSON.stringify({ spec })
  });
  const data = await r.json().catch(()=>({}));
  $("#createOut").textContent = j(data);
};
</script>
</body>
</html>
