<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Automation Builder — Wizard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0e1117; --panel:#161a22; --text:#e6edf3; --muted:#9da7b3; --brand:#49a2ff; --ok:#41d19a; --warn:#ffcf5a; --err:#ff6b6b; --border:#262b36; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text); }
    header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; }
    header h1 { font-size:18px; margin:0; }
    .wrap { max-width:1100px; margin:24px auto; padding:0 16px 40px; display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .card h2 { margin:0 0 10px 0; font-size:16px; }
    label { display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input[type="text"], textarea, select {
      width:100%; background:#0c0f14; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px; font-size:14px;
    }
    textarea { min-height:110px; resize:vertical; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .actions { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    button {
      background:#202633; color:var(--text); border:1px solid var(--border); padding:9px 12px; border-radius:10px; cursor:pointer;
    }
    button.primary { background:var(--brand); border-color:#2e7dd6; color:#00101e; font-weight:600; }
    button.ok { background:var(--ok); color:#05261a; border-color:#1b7556; }
    button.warn { background:var(--warn); color:#3b2b00; border-color:#8a6a12; }
    button.red { background:var(--err); color:#2a0606; border-color:#aa2c2c; }
    .pill { display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); background:#0c0f14; padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted); }
    .stack { display:flex; flex-direction:column; gap:10px; }
    pre {
      background:#0c0f14; border:1px solid var(--border); border-radius:10px; padding:10px; overflow:auto; font-size:12px; line-height:1.45; color:#cfe0ff;
    }
    .muted { color:var(--muted); }
    .hr { height:1px; background:var(--border); margin:10px 0; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#0c0f14; font-size:12px; color:var(--muted); }
    .bubble { background:#0c0f14; border:1px solid var(--border); border-radius:12px; padding:10px; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .kvs { display:grid; grid-template-columns: 150px 1fr; gap:6px 10px; font-size:12px; }
    .kvs b { color:#d7e3f6; }
    .footnote { font-size:12px; color:var(--muted); margin-top:8px; }
    a.link { color:#9bd1ff; text-decoration:none; }
  </style>
</head>
<body>
  <header>
    <h1>🔧 Automation Builder — Wizard</h1>
    <span class="pill">Backend: <code id="host-pill"></code></span>
    <span class="pill" id="nlp-pill">NLP: — · Provider: —</span>
  </header>

  <div class="wrap">
    <!-- שמאל: קלט ותכנון -->
    <section class="card">
      <h2>1) טקסט חופשי → תכנון אוטומציה</h2>
      <label>הנחיה (טקסט חופשי)</label>
      <textarea id="freeText" placeholder="לדוגמה: כל מייל מלקוח שלא נענה 10 שעות, הוסף לשיטס ושלח וואטסאפ"></textarea>

      <div class="row">
        <div>
          <label>ספק NLP</label>
          <select id="provider">
            <option value="">heuristic (ברירת מחדל)</option>
            <option value="ollama">ollama</option>
          </select>
        </div>
        <div>
          <label>מודל (אם Ollama)</label>
          <input id="model" type="text" placeholder="phi3:mini / qwen2.5:3b-instruct / llama3.2:3b-instruct-q4_K_M" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Spreadsheet ID (ברירת מחדל)</label>
          <input id="defSpreadsheet" type="text" placeholder="אפשר להדביק קישור מלא" />
        </div>
        <div>
          <label>WhatsApp To (ברירת מחדל, +9725…)</label>
          <input id="defWhatsTo" type="text" placeholder="+9725XXXXXXXX" />
        </div>
      </div>

      <div class="actions">
        <button class="primary" onclick="makePlan()">הפק תכנון</button>
        <button onclick="clearAll()">נקה</button>
      </div>

      <div class="hr"></div>

      <div class="stack">
        <div class="bubble">
          <div class="kvs">
            <b>סטטוס:</b><span id="status">—</span>
            <b>Provider:</b><span id="statusProvider">—</span>
            <b>Model:</b><span id="statusModel">—</span>
          </div>
        </div>
        <div>
          <div class="row" style="align-items:center; margin-bottom:6px;">
            <h3 style="margin:0;font-size:14px;">תכנון (JSON)</h3>
            <span class="badge" id="missingCount">missing: 0</span>
          </div>
          <pre id="proposalPre">{}</pre>
        </div>
      </div>
    </section>

    <!-- ימין: הרצות -->
    <section class="card">
      <h2>2) הרצה</h2>
      <div class="actions">
        <button class="warn" onclick="dryRun()">🧪 Dry-Run</button>
        <button class="ok" onclick="execute()">🚀 Execute</button>
      </div>
      <label class="muted">תוצאות</label>
      <pre id="resultsPre">—</pre>

      <div class="hr"></div>

      <h2>בדיקות מהירות</h2>
      <div class="actions">
        <button onclick="pingHealth()">בדיקת /health</button>
        <button onclick="pingEnv()">בדיקת /api/debug/env</button>
        <button onclick="getOAuthUrl()">קישור OAuth (Gmail)</button>
      </div>
      <div class="footnote">
        אם חסר Spreadsheet ID או מספר וואטסאפ — המערכת תבקש אותם אוטומטית. אפשר להזין ערכי ברירת-מחדל כאן למעלה.
      </div>
    </section>
  </div>

<script>
  const hostEl = document.getElementById('host-pill');
  hostEl.textContent = location.origin;

  const nlpPill = document.getElementById('nlp-pill');
  function setNlpPill(provider) {
    nlpPill.textContent = `NLP: ${provider ? '✔' : '—'} · Provider: ${provider || '—'}`;
  }

  const $ = (id) => document.getElementById(id);
  const pre = (el, obj) => el.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);

  function extractSheetId(v) {
    if (!v) return v;
    const m = String(v).match(/spreadsheets\/d\/([A-Za-z0-9-_]+)/);
    return m ? m[1] : v.trim();
  }

  function getDefaultsFromUI() {
    const spreadsheetId = extractSheetId($('defSpreadsheet').value || '');
    const whatsappTo = ($('defWhatsTo').value || '').trim();
    return {
      spreadsheetId: spreadsheetId || null,
      whatsappTo: whatsappTo || null,
    };
  }

  function readProposal() {
    try { return JSON.parse($('proposalPre').textContent || '{}'); }
    catch { return {}; }
  }

  function writeProposal(p) {
    pre($('proposalPre'), p || {});
  }

  function updateStatus({ ok, provider, model, missing }) {
    $('status').textContent = ok ? 'הצלחה' : 'תקלה';
    $('statusProvider').textContent = provider || '—';
    $('statusModel').textContent = model || '—';
    $('missingCount').textContent = `missing: ${missing?.length || 0}`;
    setNlpPill(provider);
  }

  function clearAll() {
    $('freeText').value = '';
    $('proposalPre').textContent = '{}';
    $('resultsPre').textContent = '—';
    updateStatus({ ok:false, provider:'', model:'', missing:[] });
  }

  async function makePlan() {
    const text = ($('freeText').value || '').trim();
    if (!text) { alert('נא לכתוב הנחיה'); return; }

    const provider = $('provider').value || '';
    const model = $('model').value || '';
    const defaults = getDefaultsFromUI();

    try {
      const r = await fetch('/api/plan/from-text', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ text, provider, model, defaults })
      });
      const j = await r.json();

      if (!j.ok) throw new Error(j.error || 'plan failed');

      // יש לנו proposal + missing
      let proposal = j.proposal || {};
      const missing = j.missing || [];

      // נסה להשלים אוטומטית מ-defaults (אם עדיין חסר)
      autoFillDefaults(proposal, missing, defaults);

      // אם עדיין חסר—בקש אינטראקטיבית
      if (missing.length) {
        proposal = await fillMissingInteractively(proposal, missing);
      }

      writeProposal(proposal);
      updateStatus({ ok:true, provider: j.provider || provider || 'heuristic', model, missing });

    } catch (e) {
      updateStatus({ ok:false, provider, model, missing:[] });
      alert('שגיאה בהפקת תכנון: ' + String(e.message || e));
    }
  }

  function autoFillDefaults(proposal, missing, defaults) {
    for (const m of missing) {
      const step = proposal.steps?.[m.step];
      if (!step) continue;
      const unit = step.trigger || step.action || {};
      unit.params = unit.params || {};
      if (m.type === 'sheets.append' && m.key === 'spreadsheetId' && !unit.params.spreadsheetId) {
        unit.params.spreadsheetId = defaults.spreadsheetId || null;
      }
      if (m.type === 'whatsapp.send' && m.key === 'to' && !unit.params.to) {
        unit.params.to = defaults.whatsappTo || null;
      }
    }
  }

  async function fillMissingInteractively(proposal, missing) {
    // מיפוי תוויות ידידותיות
    const labels = {
      'sheets.append.spreadsheetId': 'Spreadsheet ID (אפשר להדביק קישור מלא)',
      'sheets.append.sheetName': 'שם הטאב (למשל: SLA)',
      'whatsapp.send.to': 'מספר וואטסאפ (בפורמט בינלאומי, לדוגמה +9725XXXXXXX)',
      'gmail.unreplied.fromEmail': 'סינון לפי כתובת מייל (לא חובה)'
    };

    for (const m of missing) {
      const step = proposal.steps?.[m.step];
      if (!step) continue;
      const unit = step.trigger || step.action || {};
      unit.params = unit.params || {};

      const key = `${m.type}.${m.key}`;
      let label = labels[key] || `ערך חסר עבור ${m.key} ב-${m.type}`;
      let val = prompt(`שדה נדרש: ${label}`, '');

      if (val == null) throw new Error('בוטל ע"י המשתמש');

      // המרה נוחה ל־Spreadsheet ID
      if (m.type === 'sheets.append' && m.key === 'spreadsheetId') {
        val = extractSheetId(val);
      }

      unit.params[m.key] = String(val).trim();
    }
    return proposal;
  }

  async function dryRun() {
    const proposal = readProposal();
    if (!proposal?.steps?.length) { alert('אין תכנון להרצה'); return; }
    try {
      const r = await fetch('/api/automations/dry-run', {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify(proposal)
      });
      const j = await r.json();
      pre($('resultsPre'), j);
    } catch (e) {
      pre($('resultsPre'), String(e.message || e));
    }
  }

  async function execute() {
    const proposal = readProposal();
    if (!proposal?.steps?.length) { alert('אין תכנון להרצה'); return; }
    try {
      const r = await fetch('/api/automations/execute', {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify(proposal)
      });
      const j = await r.json();
      pre($('resultsPre'), j);
    } catch (e) {
      pre($('resultsPre'), String(e.message || e));
    }
  }

  async function pingHealth() {
    try {
      const t = await (await fetch('/health')).text();
      pre($('resultsPre'), t);
    } catch (e) {
      pre($('resultsPre'), String(e.message || e));
    }
  }
  async function pingEnv() {
    try {
      const j = await (await fetch('/api/debug/env')).json();
      pre($('resultsPre'), j);
    } catch (e) {
      pre($('resultsPre'), String(e.message || e));
    }
  }
  async function getOAuthUrl() {
    try {
      const j = await (await fetch('/api/google/oauth/url')).json();
      if (j.ok && j.url) window.open(j.url, '_blank');
      else alert('שגיאת OAuth: ' + (j.error || ''));
    } catch (e) {
      alert('שגיאת OAuth: ' + String(e.message || e));
    }
  }
</script>
</body>
</html>
