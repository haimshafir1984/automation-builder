<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Wizard Plus — Chat UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadein .4s ease; }
    @keyframes fadein { from {opacity:0; transform: translateY(6px)} to {opacity:1; transform:none} }
    .bubble{ background:#0b1323; border:1px solid #273244; color:#e5e7eb; }
    .bubble.user{ background:#121a2b; }
    .btn {
      appearance:none; border:none; border-radius:12px; padding:12px 16px;
      background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff;
      box-shadow: 0 10px 18px rgba(0,0,0,0.15), inset 0 -3px 0 rgba(0,0,0,.15);
      cursor:pointer; font-weight:700;
    }
    .btn:hover{ filter:brightness(0.97) }
    .btn-ghost{ background:transparent; color:#374151; border:1px solid #e5e7eb }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px; border:1px solid #37415133 }
    .pill-ok{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.3); color:#0bb37b;}
    .pill-err{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35); color:#ef4444;}
    /* תשובות/אינפוטים בבועות – רקע לבן וטקסט כהה כדי שלא "ייעלם" */
    .chat-input { background:#ffffff; color:#111827; border:1px solid #e5e7eb; }
    code { background:#0b1220; padding:2px 6px; border-radius:6px; border:1px solid #1f2937; }
  </style>
</head>
<body class="min-h-screen bg-gray-100 text-gray-100 flex">
  <!-- Sidebar -->
  <aside class="w-64 bg-white text-gray-800 shadow-lg p-6 hidden md:block">
    <h2 class="text-xl font-bold mb-6">📂 האוטומציות שלי</h2>
    <ul class="space-y-3">
      <li class="p-3 bg-blue-100 text-blue-700 rounded-lg font-medium">אוטומציה חדשה</li>
      <li class="p-3 hover:bg-gray-100 rounded-lg cursor-pointer">SLA מיילים</li>
      <li class="p-3 hover:bg-gray-100 rounded-lg cursor-pointer">סיכום יומי</li>
      <li class="p-3 hover:bg-gray-100 rounded-lg cursor-pointer">תבניות WhatsApp</li>
    </ul>
    <div class="mt-8">
      <p class="text-xs text-gray-400">גרסה 0.4 · Prototype</p>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-6 md:p-10">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-gray-800">✨ צור אוטומציה חדשה</h1>
      <div class="flex items-center gap-3">
        <span id="g-status" class="pill">טוען…</span>
        <span id="g-email" class="text-sm text-gray-500"></span>
        <button id="btn-g-connect" class="px-4 py-2 btn">🔑 התחבר עם Google</button>
        <button id="btn-g-disconnect" class="px-4 py-2 btn-ghost rounded-lg">התנתק</button>
      </div>
    </header>

    <!-- Composer -->
    <section class="bg-white text-gray-800 shadow-lg rounded-2xl p-8 max-w-3xl">
      <label class="block text-sm text-gray-600 mb-2">תאר מה אתה צריך:</label>
      <textarea id="free-text"
        class="w-full h-40 border rounded-xl p-4 outline-none focus:ring-2 focus:ring-blue-300 mb-6"
        placeholder='דוגמה: "כל מייל שהגיע ממשתמש מסוים בחודש האחרון ושלא עניתי לו ב-5 שעות — תכניס לגוגל שיט / שלח לי בוואטסאפ"'></textarea>
      <div class="flex gap-3">
        <button id="btn-create" class="btn">🚀 צור אוטומציה</button>
        <button id="btn-debug-nlp" class="btn-ghost px-4 py-2 rounded-xl">בדיקת NLP</button>
      </div>
    </section>

    <!-- Chat Section -->
    <section class="mt-8">
      <div id="chat" class="space-y-3"></div>
    </section>

    <!-- Quick defaults (שמורות בדפדפן שלך; לא משנה עיצוב קיים) -->
    <section class="mt-8 bg-white text-gray-800 shadow rounded-2xl p-4">
      <div class="text-sm text-gray-700 mb-2">ברירות־מחדל (שמורות מקומית ב־localStorage)</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="def_spreadsheetId" class="chat-input rounded-xl p-2" placeholder="Spreadsheet ID או URL מלא">
        <input id="def_sheetName" class="chat-input rounded-xl p-2" placeholder="Sheet name (לשונית)">
        <input id="def_to" class="chat-input rounded-xl p-2" placeholder="יעד: name@example.com או 9725xxxxxxx">
      </div>
      <div class="mt-2">
        <button id="btn-save-defaults" class="btn-ghost px-3 py-1 rounded-lg">שמור ברירות־מחדל</button>
      </div>
    </section>
  </main>

  <script>
// -------- Config (same-origin) --------
const API_BASE = '';

// -------- UI Helpers (reuse existing classes) --------
function addBubble(text, who='sys') {
  const chat = document.getElementById('chat');
  const wrap = document.createElement('div');
  wrap.className = 'fade-in flex ' + (who==='user' ? 'justify-end' : 'justify-start');
  const b = document.createElement('div');
  b.className = 'bubble rounded-2xl px-4 py-3 max-w-[80%] ' + (who==='user' ? 'user' : '');
  b.innerHTML = text;
  wrap.appendChild(b);
  chat.appendChild(wrap);
  b.scrollIntoView({ behavior:'smooth', block:'end' });
  return b;
}
function addInputBubble(placeholder, type='text', widthClass='w-72') {
  const chat = document.getElementById('chat');
  const wrap = document.createElement('div');
  wrap.className = 'fade-in flex justify-end';
  const input = document.createElement('input');
  input.type = type;
  input.placeholder = placeholder || '';
  input.className = `chat-input rounded-2xl p-3 ${widthClass} shadow outline-none focus:ring-2 focus:ring-blue-300`;
  wrap.appendChild(input);
  chat.appendChild(wrap);
  input.scrollIntoView({ behavior:'smooth', block:'end' });
  input.focus();
  return input;
}
function addButtonBubble(label, onClick) {
  const chat = document.getElementById('chat');
  const wrap = document.createElement('div');
  wrap.className = 'fade-in flex justify-start';
  const btn = document.createElement('button');
  btn.className = 'btn rounded-2xl';
  btn.textContent = label;
  btn.onclick = onClick;
  wrap.appendChild(btn);
  chat.appendChild(wrap);
  btn.scrollIntoView({ behavior:'smooth', block:'end' });
  return btn;
}
function setGoogleStatus(connected, email) {
  const s = document.getElementById('g-status');
  s.textContent = connected ? 'מחובר' : 'לא מחובר';
  s.className = 'pill ' + (connected ? 'pill-ok' : 'pill-err');
  document.getElementById('g-email').textContent = connected && email ? `(${email})` : '';
}

// -------- Small utils --------
function normalizeHebClient(s=''){
  return String(s)
    .replace(/[\u200e\u200f]/g,'')
    .replace(/[“”„״]/g, '"')
    .replace(/[’׳]/g, "'")
    .replace(/[–—]/g, '-')
    .replace(/ווא?טסאפ|ווטסאפ/gi, 'WhatsApp')
    .replace(/גוגל\s*שיט|שיט\b/gi, 'Sheet')
    .replace(/\s+/g, ' ')
    .trim()
    .replace(/\bבשם\s+/gi, '');
}

// Defaults in localStorage
function getDefaults(){ try { return JSON.parse(localStorage.getItem('defaults')||'{}'); } catch { return {}; } }
function setDefault(k,v){ const d=getDefaults(); d[k]=v; localStorage.setItem('defaults', JSON.stringify(d)); }
function getDefault(k){ return getDefaults()[k]||''; }

// Prefill defaults panel if present
function loadDefaultsToPanel(){
  const a = document.getElementById('def_spreadsheetId'); if (a) a.value = getDefault('spreadsheetId');
  const b = document.getElementById('def_sheetName'); if (b) b.value = getDefault('sheetName');
  const c = document.getElementById('def_to'); if (c) c.value = getDefault('to');
}
function saveDefaultsFromPanel(){
  const a = document.getElementById('def_spreadsheetId'); if (a) setDefault('spreadsheetId', a.value.trim());
  const b = document.getElementById('def_sheetName'); if (b) setDefault('sheetName', b.value.trim());
  const c = document.getElementById('def_to'); if (c) setDefault('to', c.value.trim());
}

// -------- Google auth via our backend --------
async function refreshGoogleAccount() {
  try {
    const r = await fetch('/api/google/auth/status');
    const j = await r.json();
    if (j && j.hasRefreshToken) {
      try {
        const me = await fetch('/api/google/me').then(x=>x.json());
        setGoogleStatus(true, me && me.email ? me.email : '');
      } catch { setGoogleStatus(true, ''); }
    } else {
      setGoogleStatus(false, '');
    }
  } catch { setGoogleStatus(false, ''); }
}
async function connectGoogle() {
  const r = await fetch('/api/google/oauth/url');
  const j = await r.json();
  if (!j.ok || !j.url) { addBubble('❌ שגיאה ביצירת קישור Google OAuth'); return; }
  window.open(j.url, 'google_auth', 'width=520,height=640');
}
async function disconnectGoogle() {
  await fetch('/api/google/logout', { method:'POST' });
  refreshGoogleAccount();
}

// -------- NLP Plan with Groq/Heuristic backend --------
let lastPlan = null;

function showPlanBubble(obj){
  const pretty = `<pre class="text-xs mt-2"><code>${JSON.stringify(obj, null, 2).replace(/</g,'&lt;').replace(/>/g,'&gt;')}</code></pre>`;
  addBubble(`Intent: — · Provider: <code>${obj.provider || '—'}</code>${pretty}`);
}

async function planFromText(textRaw){
  const text = normalizeHebClient(textRaw || document.getElementById('free-text').value || '');
  if (!text) { addBubble('❌ לא התקבל טקסט'); return; }
  addBubble('🔎 מריץ /api/plan/from-text…');
  try{
    const r = await fetch('/api/plan/from-text', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ text })
    });
    const j = await r.json();
    lastPlan = j;
    showPlanBubble(j);
    if (j && Array.isArray(j.missing) && j.missing.length){
      askMissingFieldsGeneric([...j.missing], j.proposal || []);
    } else if (j && j.proposal && j.proposal.length){
      addButtonBubble('הפעל עכשיו', async ()=>{ await executeWithPlanAndAnswers({}); });
    } else {
      addBubble('❌ לא זוהתה כוונה. נסו לנסח עם המקור (Gmail/Sheet) והיעד (Email/WhatsApp).');
    }
  }catch(e){
    addBubble('❌ שגיאה בתכנון');
  }
}

// Generic missing-fields flow based on array of {key,label,example}
async function askMissingFieldsGeneric(missingArr, proposal){
  if (!missingArr || !missingArr.length){
    addButtonBubble('הפעל עכשיו', async ()=>{ await executeWithPlanAndAnswers({}); });
    return;
  }
  const next = missingArr.shift();
  const question = next.label || next.key || 'ערך חסר';
  addBubble(question, 'sys');
  const ph = next.example || '';
  const input = addInputBubble(ph || '', 'text', 'w-80');
  addButtonBubble('המשך', async ()=>{
    const val = (input.value||'').trim();
    if (!val){ addBubble('❌ ערך חסר'); return; }
    if (['spreadsheetId','sheetName','to','fromEmail'].includes(next.key)) setDefault(next.key, val);
    if (lastPlan){
      lastPlan._answers = lastPlan._answers || {};
      lastPlan._answers[next.key] = val;
    }
    addBubble(val, 'user');
    await askMissingFieldsGeneric(missingArr, proposal);
  });
}

// Patch answers into steps (proposal)
function applyAnswersToSteps(steps, answers){
  const patch = (obj)=>{
    if (!obj || typeof obj!=='object') return;
    for (const k of Object.keys(obj)){
      if (obj[k]==='' && answers[k]) obj[k] = answers[k];
      if (typeof obj[k]==='object') patch(obj[k]);
    }
  };
  for (const s of (steps||[])){
    if (s.trigger && s.trigger.params) patch(s.trigger.params);
    if (s.action && s.action.params) patch(s.action.params);
  }
  return steps;
}

// Execute via our backend
async function executeWithPlanAndAnswers(extraAnswers){
  if (!lastPlan || !Array.isArray(lastPlan.proposal) || !lastPlan.proposal.length){
    addBubble('❌ אין תכנית פעילה להרצה');
    return;
  }
  const answers = Object.assign({}, lastPlan._answers || {}, extraAnswers || {});
  const steps = applyAnswersToSteps(JSON.parse(JSON.stringify(lastPlan.proposal)), answers);
  addBubble('⚙️ מריץ /api/automations/execute…');
  try{
    const r = await fetch('/api/automations/execute', {
      method:'POST',
      headers:{ 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: document.getElementById('free-text').value || '', steps })
    });
    const j = await r.json();
    const pretty = `<pre class="text-xs mt-2"><code>${JSON.stringify(j, null, 2).replace(/</g,'&lt;').replace(/>/g,'&gt;')}</code></pre>`;
    if (j.ok){
      addBubble('✅ בוצע בהצלחה' + pretty);
    } else {
      addBubble('❌ שגיאה בהרצה' + pretty);
    }
  }catch(e){
    addBubble('❌ שגיאה בהרצה');
  }
}

// Bindings
document.getElementById('btn-g-connect').addEventListener('click', connectGoogle);
document.getElementById('btn-g-disconnect').addEventListener('click', disconnectGoogle);
document.getElementById('btn-debug-nlp').addEventListener('click', ()=> planFromText());
document.getElementById('btn-create').addEventListener('click', ()=> planFromText());
document.getElementById('btn-save-defaults').addEventListener('click', ()=> {
  saveDefaultsFromPanel();
  addBubble('✅ ברירות־מחדל נשמרו (מקומית בדפדפן)');
});

// init
refreshGoogleAccount();
loadDefaultsToPanel();
  </script>
</body>
</html>
