<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Wizard Plus â€” Chat UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind (×¢×™×¦×•×‘ ×”×××•×©×¨) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadein .4s ease; }
    @keyframes fadein { from {opacity:0; transform: translateY(6px)} to {opacity:1; transform:none} }
    .bubble{ background:#0b1323; border:1px solid #273244; color:#e5e7eb; }
    .bubble.user{ background:#121a2b; }
    .btn {
      appearance:none; border:none; border-radius:12px; padding:12px 16px;
      background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff;
      box-shadow: 0 10px 18px rgba(0,0,0,0.15), inset 0 -3px 0 rgba(0,0,0,.15);
      cursor:pointer; font-weight:700;
    }
    .btn:hover{ filter:brightness(0.97) }
    .btn-ghost{ background:transparent; color:#374151; border:1px solid #e5e7eb; border-radius:12px; padding:10px 14px; font-weight:600 }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px; border:1px solid #37415133 }
    .pill-ok{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.3); color:#0bb37b;}
    .pill-err{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35); color:#ef4444;}
    .chat-input { background:#ffffff; color:#111827; border:1px solid #e5e7eb; }
    code { background:#0b1220; padding:2px 6px; border-radius:6px; border:1px solid #1f2937; }
    .card { background:#ffffff; color:#111827; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 8px 18px rgba(0,0,0,0.06); }
    .chip { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .chip:hover { background:#f7f7fb; }
    .tag { font-size:11px; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; }
    .section-title { font-weight:800; color:#111827; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body class="min-h-screen bg-gray-100 text-gray-100 flex">
  <!-- ==== ××¤×œ×™×§×¦×™×” ××—×ª ×‘×œ×‘×“! ==== -->

  <!-- Sidebar -->
  <aside class="w-64 bg-white text-gray-800 shadow-lg p-6 hidden md:flex md:flex-col">
    <h2 class="text-xl font-bold mb-4">ğŸ“‚ ×”××•×˜×•××¦×™×•×ª ×©×œ×™</h2>
    <div class="mb-3">
      <input id="autos-search" class="w-full chat-input rounded-xl p-2" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©×â€¦" />
    </div>
    <ul id="autos-list" class="space-y-3 overflow-auto" style="max-height: 55vh;">
      <li class="p-3 bg-blue-50 text-blue-700 rounded-lg font-medium">×˜×•×¢×Ÿâ€¦</li>
    </ul>
    <div class="mt-4 text-xs text-gray-400">Prototype â€¢ 0.5</div>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-6 md:p-10">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-gray-800">âœ¨ ×¦×•×¨ ××•×˜×•××¦×™×” ×—×“×©×”</h1>
      <div class="flex items-center gap-3">
        <span id="g-status" class="pill">×˜×•×¢×Ÿâ€¦</span>
        <span id="g-email" class="text-sm text-gray-500"></span>
        <button id="btn-g-connect" class="px-4 py-2 btn">ğŸ”‘ ×”×ª×—×‘×¨ ×¢× Google</button>
        <button id="btn-g-disconnect" class="btn-ghost">×”×ª× ×ª×§</button>
      </div>
    </header>

    <!-- Composer -->
    <section class="card p-6 max-w-4xl">
      <div class="flex items-center justify-between">
        <div>
          <div class="section-title">×ª××¨ ××” ××ª×” ×¦×¨×™×š</div>
          <div class="text-gray-500 text-sm">××¤×©×¨ ×‘×¢×‘×¨×™×ª, ×’× ×¢× ×©×’×™××•×ª ×§×˜× ×•×ª. ××©×œ×™× ×¤×¨×˜×™× ×—×¡×¨×™×.</div>
        </div>
        <div class="text-xs text-gray-500">
          <span id="nlp-provider" class="tag">NLP: â€”</span>
        </div>
      </div>
      <textarea id="free-text"
        class="w-full h-36 border rounded-xl p-4 outline-none focus:ring-2 focus:ring-blue-300 my-4"
        placeholder='×“×•×’××”: "×›×œ ××™×™×œ ×-haim@example.com ×©×œ× × ×¢× ×” 10 ×©×¢×•×ª ×‘-30 ×™××™× â†’ ×”×•×¡×£ ×œ-Google Sheet ×‘×©× InboxLog"' ></textarea>

      <div class="flex flex-wrap gap-3">
        <button id="btn-create" class="btn">ğŸš€ ×¦×•×¨/×¢×“×›×Ÿ ×ª×›× ×™×ª</button>
        <button id="btn-debug-nlp" class="btn-ghost">×‘×“×™×§×ª NLP</button>
        <label class="flex items-center gap-2 text-sm text-gray-600">
          <input id="chk-dry" type="checkbox" class="rounded" />
          ×”×¨×¦×” × ×™×¡×™×•× ×™×ª (Dry-Run)
        </label>
      </div>
    </section>

    <!-- Suggested automations -->
    <section class="mt-6 card p-6 max-w-4xl">
      <div class="section-title mb-3">××•×˜×•××¦×™×•×ª ××•×¦×¢×•×ª</div>
      <div class="flex flex-wrap gap-2" id="suggested"></div>
      <div class="text-xs text-gray-500 mt-2">×œ×—×™×¦×” ××›× ×™×¡×” ×˜×§×¡×˜ ×œ×“×•×’××” ×•××ª×—×™×œ×” ××™×¡×•×£ ×¤×¨×˜×™× ×—×¡×¨×™×.</div>
    </section>

    <!-- Chat Section -->
    <section class="mt-6">
      <div id="chat" class="space-y-3"></div>
    </section>

    <!-- Review & Edit -->
    <section id="review" class="mt-6 card p-6 max-w-4xl hidden">
      <div class="section-title mb-3">×¢×¨×™×›×” ×œ×¤× ×™ ×”×¨×¦×” (Review & Edit)</div>
      <div id="review-steps" class="space-y-4"></div>
      <div class="mt-4 flex gap-3">
        <button id="btn-run-reviewed" class="btn">×”×¨×¥ ×¢× ×”×¢×¨×™×›×•×ª</button>
        <button id="btn-save-automation" class="btn-ghost">×©××•×¨ ×›××•×˜×•××¦×™×”</button>
      </div>
    </section>

    <!-- Defaults -->
    <section class="mt-6 card p-4 max-w-4xl">
      <div class="text-sm text-gray-700 mb-2">×‘×¨×™×¨×•×ªÖ¾××—×“×œ (× ×©××¨×•×ª ××§×•××™×ª ×‘×“×¤×“×¤×Ÿ)</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="def_spreadsheetId" class="chat-input rounded-xl p-2" placeholder="Spreadsheet ID ××• URL ××œ×">
        <input id="def_sheetName" class="chat-input rounded-xl p-2" placeholder="Sheet name (×œ×©×•× ×™×ª)">
        <input id="def_to" class="chat-input rounded-xl p-2" placeholder="×™×¢×“: name@example.com ××• 9725xxxxxxx">
      </div>
      <div class="mt-2">
        <button id="btn-save-defaults" class="btn-ghost">×©××•×¨ ×‘×¨×™×¨×•×ªÖ¾××—×“×œ</button>
      </div>
    </section>
  </main>

  <script>
/* ====================== Utils ====================== */
const API_BASE = '';
const esc = (s='')=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
function addBubble(html, who='sys'){
  const chat=document.getElementById('chat');
  const wrap=document.createElement('div'); wrap.className='fade-in flex '+(who==='user'?'justify-end':'justify-start');
  const b=document.createElement('div'); b.className='bubble rounded-2xl px-4 py-3 max-w-[820px] '+(who==='user'?'user':''); b.innerHTML=html;
  wrap.appendChild(b); chat.appendChild(wrap); b.scrollIntoView({behavior:'smooth',block:'end'}); return b;
}
function addInputBubble(placeholder,type='text',widthClass='w-96'){
  const chat=document.getElementById('chat'); const wrap=document.createElement('div'); wrap.className='fade-in flex justify-end';
  const i=document.createElement('input'); i.type=type; i.placeholder=placeholder||''; i.className=`chat-input rounded-2xl p-3 ${widthClass} shadow outline-none focus:ring-2 focus:ring-blue-300`;
  wrap.appendChild(i); chat.appendChild(wrap); i.scrollIntoView({behavior:'smooth',block:'end'}); i.focus(); return i;
}
function addButtonBubble(label,onClick){
  const chat=document.getElementById('chat'); const wrap=document.createElement('div'); wrap.className='fade-in flex justify-start';
  const btn=document.createElement('button'); btn.className='btn rounded-2xl'; btn.textContent=label; btn.onclick=onClick;
  wrap.appendChild(btn); chat.appendChild(wrap); btn.scrollIntoView({behavior:'smooth',block:'end'}); return btn;
}
function normalizeHebClient(s=''){
  return String(s).replace(/[\u200e\u200f]/g,'').replace(/[â€œâ€â€×´]/g,'"').replace(/[â€™×³]/g,"'")
    .replace(/[â€“â€”]/g,'-').replace(/×•×•×?×˜×¡××¤|×•×•×˜×¡××¤/gi,'WhatsApp').replace(/×’×•×’×œ\s*×©×™×˜|×©×™×˜\b/gi,'Sheet')
    .replace(/\s+/g,' ').trim().replace(/\b×‘×©×\s+/gi,'');
}
const mono = (obj)=> `<pre class="text-xs mt-2"><code>${esc(JSON.stringify(obj,null,2))}</code></pre>`;

/* ====================== Defaults ====================== */
function getDefaults(){ try{ return JSON.parse(localStorage.getItem('defaults')||'{}'); }catch{ return {}; } }
function setDefault(k,v){ const d=getDefaults(); d[k]=v; localStorage.setItem('defaults', JSON.stringify(d)); }
function getDefault(k){ return getDefaults()[k]||''; }
function loadDefaultsToPanel(){ ['spreadsheetId','sheetName','to'].forEach(k=>{ const el=document.getElementById('def_'+k); if(el) el.value=getDefault(k); }); }
function saveDefaultsFromPanel(){ ['spreadsheetId','sheetName','to'].forEach(k=>{ const el=document.getElementById('def_'+k); if(el) setDefault(k, (el.value||'').trim()); }); addBubble('âœ… ×‘×¨×™×¨×•×ªÖ¾××—×“×œ × ×©××¨×•', 'sys'); }

/* ====================== Google ====================== */
function setGoogleStatus(connected,email){ const s=document.getElementById('g-status'); s.textContent=connected?'××—×•×‘×¨':'×œ× ××—×•×‘×¨'; s.className='pill '+(connected?'pill-ok':'pill-err'); document.getElementById('g-email').textContent=connected&&email?`(${email})`:''; }
async function refreshGoogleAccount(){ try{ const j=await (await fetch('/api/google/auth/status')).json(); if(j?.hasRefreshToken){ try{ const me=await (await fetch('/api/google/me')).json(); setGoogleStatus(true, me?.emailAddress||''); }catch{ setGoogleStatus(true,''); } } else setGoogleStatus(false,''); } catch{ setGoogleStatus(false,''); } }
async function connectGoogle(){ const j=await (await fetch('/api/google/oauth/url')).json(); if(!j.ok||!j.url){ addBubble('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×§×™×©×•×¨ Google OAuth'); return; } window.open(j.url,'google_auth','width=520,height=640'); }
async function disconnectGoogle(){ await fetch('/api/google/logout',{method:'POST'}); refreshGoogleAccount(); }

/* ====================== Suggested ====================== */
const SUGGESTED = [
  { title:'××™×™×œ×™× ×©×œ× × ×¢× ×• â†’ WhatsApp', tag:'Gmailâ†’WA', text:'×›×œ ××™×™×œ ×-name@example.com ×©×œ× × ×¢× ×” ×‘××©×š 10 ×©×¢×•×ª ×‘-30 ×™××™× ×”××—×¨×•× ×™× â€” ×©×œ×— ×œ×™ ×”×•×“×¢×ª WhatsApp ×¢× ×”× ×•×©× ×•×§×™×©×•×¨ ×œ×©×™×—×”' },
  { title:'×©× ×™ ×©×•×œ×—×™× â†’ ×œ×•×’ ×‘×’×™×œ×™×•×Ÿ', tag:'Gmailâ†’Sheets', text:'×× ×™ ×¨×•×¦×” ×œ×‘× ×•×ª ×˜×‘×œ×” ××©×•×ª×¤×ª ×œ×©× ×™ ×× ×©×™×; ×›×œ ×¤×¢× ×©××—×“ ××”× ×©×•×œ×— ××™×™×œâ€”×œ×”×•×¡×™×£ ×©×•×¨×” ×¢× ×”×©×•×œ×—, ×”×ª××¨×™×š, ×”× ×•×©×, ×•×”×ª×•×›×Ÿ' },
  { title:'×ª××™××•×ª ×¢×¨×š ×‘×’×™×œ×™×•×Ÿ â†’ ××™×™×œ', tag:'Sheetsâ†’Email', text:'×›×©×”×¢××•×“×” "project menger" ×©×•×•×” "haim shafir" ×‘×œ×©×•× ×™×ª Sheet1 â€” ×©×œ×— ×œ×™ ××ª ×›×œ ×”×©×•×¨×” ×‘××™×™×œ' }
];
function renderSuggested(){
  const wrap=document.getElementById('suggested'); wrap.innerHTML='';
  SUGGESTED.forEach(s=>{ const chip=document.createElement('div'); chip.className='chip'; chip.innerHTML=`<span>${esc(s.title)}</span><span class="tag">${esc(s.tag)}</span>`; chip.onclick=()=>{ document.getElementById('free-text').value=s.text; planFromText(s.text,true); }; wrap.appendChild(chip); });
}

/* ====================== NLP & Slot-Filling ====================== */
let lastPlan=null, lastStepsEditable=[];
function updateProviderTag(p){ document.getElementById('nlp-provider').textContent='NLP: '+(p||'â€”'); }
function showPlanBubble(obj){ updateProviderTag(obj?.provider||'â€”'); addBubble(`Intent: â€” Â· Provider: <code>${esc(obj?.provider||'â€”')}</code>${mono(obj)}`); }
function renderMissingQuestions(m){ if(!m?.length){ addBubble('××™×Ÿ ×¤×¨×˜×™× ×—×¡×¨×™× ×›×¨×’×¢. ××¤×©×¨ ×œ×”×¨×™×¥.', 'sys'); return; } addBubble('×¦×¨×™×š ×œ×”×©×œ×™× ×›××” ×¤×¨×˜×™×. ××“×¨×™×š ××•×ª×š ××—×“-××—×“:', 'sys'); }

async function planFromText(textRaw){
  const text=normalizeHebClient(textRaw||document.getElementById('free-text').value||''); if(!text){ addBubble('âŒ ×œ× ×”×ª×§×‘×œ ×˜×§×¡×˜'); return; }
  addBubble('ğŸ” ××¨×™×¥ /api/plan/from-textâ€¦','sys');
  try{
    const j=await (await fetch('/api/plan/from-text',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})})).json();
    lastPlan=j; showPlanBubble(j);
    if(j?.missing?.length){ renderMissingQuestions(j.missing); askMissingFieldsGeneric([...j.missing], j.proposal||[]); }
    else if(j?.proposal?.length){ addBubble('âœ… ×ª×›× ×™×ª ××•×›× ×”. ××¤×©×¨ ×œ×”×¨×™×¥ ××• ×œ×¤×ª×•×— ×¢×¨×™×›×” ×œ×¤× ×™ ×”×¨×¦×”.', 'sys'); buildReviewEditor(j.proposal); addButtonBubble('×¤×ª×— ×¢×¨×™×›×”',()=>document.getElementById('review').classList.remove('hidden')); addButtonBubble('×”×¤×¢×œ ×¢×›×©×™×•',()=>executeWithPlanAndAnswers({})); }
    else { addBubble('âŒ ×œ× ×–×•×”×ª×” ×›×•×•× ×”. × ×¡×• ×œ×¦×™×™×Ÿ ××§×•×¨ (Gmail/Sheet) ×•×™×¢×“ (Email/WhatsApp).','sys'); }
  }catch{ addBubble('âŒ ×©×’×™××” ×‘×ª×›× ×•×Ÿ','sys'); }
}
async function askMissingFieldsGeneric(missingArr,proposal){
  if(!missingArr?.length){ buildReviewEditor(proposal); addButtonBubble('×¤×ª×— ×¢×¨×™×›×”',()=>document.getElementById('review').classList.remove('hidden')); addButtonBubble('×”×¤×¢×œ ×¢×›×©×™×•',()=>executeWithPlanAndAnswers({})); return; }
  const next=missingArr.shift(); const q=next.label||next.key||'×¢×¨×š ×—×¡×¨'; addBubble(esc(q),'sys');
  const ph=next.example||(next.key==='to'?'name@example.com ××• 9725xxxxxxx':''); const input=addInputBubble(ph,'text','w-96');
  const d=getDefault(next.key); if(d) input.value=d;
  addButtonBubble('×”××©×š', async ()=>{ const val=(input.value||'').trim(); if(!val){ addBubble('âŒ ×¢×¨×š ×—×¡×¨','sys'); return; } if(['spreadsheetId','sheetName','to','fromEmail','fromEmails'].includes(next.key)) setDefault(next.key,val); lastPlan._answers ||= {}; lastPlan._answers[next.key]=val; addBubble(esc(val),'user'); await askMissingFieldsGeneric(missingArr,proposal); });
}

/* Review & Edit */
function buildReviewEditor(steps){
  const host=document.getElementById('review-steps'); host.innerHTML=''; document.getElementById('review').classList.remove('hidden');
  lastStepsEditable=JSON.parse(JSON.stringify(steps||[]));
  (lastStepsEditable||[]).forEach((s,idx)=>{
    const isTrig=!!s.trigger; const name=isTrig?s.trigger.type:s.action.type; const params=isTrig?(s.trigger.params||{}):(s.action.params||{});
    const card=document.createElement('div'); card.className='border rounded-xl p-4';
    let html=`<div class="font-bold mb-2">${isTrig?'Trigger':'Action'}: <span class="mono">${esc(name)}</span></div><div class="grid md:grid-cols-2 gap-3">`;
    Object.keys(params).forEach(k=>{ const v=params[k]; html+=`<label class="text-sm"><div class="text-gray-600 mb-1">${esc(k)}</div><input data-idx="${idx}" data-kind="${isTrig?'trigger':'action'}" data-key="${esc(k)}" class="chat-input w-full rounded-lg p-2" value="${esc(String(v))}" /></label>`; });
    html+='</div>'; card.innerHTML=html; host.appendChild(card);
  });
}
function collectReviewedSteps(){
  document.querySelectorAll('#review-steps input[data-key]').forEach(el=>{ const idx=+el.dataset.idx, kind=el.dataset.kind, key=el.dataset.key, val=el.value; if(kind==='trigger') lastStepsEditable[idx].trigger.params[key]=val; else lastStepsEditable[idx].action.params[key]=val; });
  return lastStepsEditable;
}
function applyAnswersToSteps(steps,answers){
  const patch=o=>{ if(!o||typeof o!=='object') return; for(const k of Object.keys(o)){ if(o[k]===''&&answers[k]) o[k]=answers[k]; if(typeof o[k]==='object') patch(o[k]); } };
  (steps||[]).forEach(s=>{ if(s.trigger) patch(s.trigger.params); if(s.action) patch(s.action.params); });
  return steps;
}

/* Execute */
async function executeWithPlanAndAnswers(extraAnswers,reviewed=false){
  if(!lastPlan){ addBubble('âŒ ××™×Ÿ ×ª×›× ×™×ª ×¤×¢×™×œ×”','sys'); return; }
  let steps=reviewed?collectReviewedSteps():JSON.parse(JSON.stringify(lastPlan.proposal||[]));
  const answers=Object.assign({}, lastPlan._answers||{}, extraAnswers||{}); steps=applyAnswersToSteps(steps,answers);
  const dry=document.getElementById('chk-dry')?.checked||false;
  addBubble(`âš™ï¸ ××¨×™×¥ /api/automations/execute${dry?' (Dry-Run)':''}â€¦`,'sys');
  try{
    const j=await (await fetch('/api/automations/execute',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ text:document.getElementById('free-text').value||'', steps, dryRun:dry })})).json();
    addBubble((j.ok?'âœ… ×”×¦×œ×—×”':'âŒ ×©×’×™××”')+mono(j),'sys');
  }catch{ addBubble('âŒ ×©×’×™××” ×‘×”×¨×¦×”','sys'); }
}

/* Save automation & Sidebar */
async function saveAutomation(){
  if(!lastPlan){ addBubble('âŒ ××™×Ÿ ×ª×›× ×™×ª ×¤×¢×™×œ×”','sys'); return; }
  const titleInput=addInputBubble('×©× ×œ××•×˜×•××¦×™×” (×œ××©×œ: SLA ×œ×•×•××˜×¡××¤)','text','w-96');
  addButtonBubble('×©××•×¨', async ()=>{ const title=(titleInput.value||'').trim()||'××•×˜×•××¦×™×” ×œ×œ× ×©×'; const steps=collectReviewedSteps();
    const j=await (await fetch('/api/automations/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ steps, text:document.getElementById('free-text').value||'', title })})).json();
    if(j.ok){ addBubble(`âœ… × ×©××¨ (id: <span class="mono">${esc(j.id)}</span>)`,'sys'); loadMyAutomations(); } else addBubble('âŒ ×©××™×¨×” × ×›×©×œ×”'+mono(j),'sys');
  });
}
async function loadMyAutomations(){ const ul=document.getElementById('autos-list'); ul.innerHTML='<li class="p-3 rounded-lg border">×˜×•×¢×Ÿâ€¦</li>';
  try{ const j=await (await fetch('/api/automations/list')).json(); if(!j.ok){ ul.innerHTML='<li class="p-3 rounded-lg border text-red-600">×©×’×™××” ×‘×˜×¢×™× ×”</li>'; return; } renderAutos(j.items||[]); }
  catch{ ul.innerHTML='<li class="p-3 rounded-lg border text-red-600">×©×’×™××” ×‘×˜×¢×™× ×”</li>'; } }
function renderAutos(items){
  const ul=document.getElementById('autos-list'); ul.innerHTML=''; const q=(document.getElementById('autos-search')?.value||'').trim().toLowerCase();
  items.filter(x=>!q||(x.title||'').toLowerCase().includes(q)).forEach(x=>{
    const li=document.createElement('li'); li.className='p-3 rounded-lg border';
    li.innerHTML=`<div class="font-semibold
