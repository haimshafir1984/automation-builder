<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Wizard Plus â€” Chat UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#0b1020; }
    .fade-in { animation: fadein .4s ease; }
    @keyframes fadein { from {opacity:0; transform: translateY(6px)} to {opacity:1; transform:none} }
    .bubble{ background:#0b1323; border:1px solid #273244; color:#e5e7eb; border-radius:12px; padding:12px 14px; }
    .bubble.user{ background:#121a2b; }
    .btn {
      appearance:none; border:none; border-radius:12px; padding:12px 16px;
      background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff;
      cursor:pointer; font-weight:700; letter-spacing:.3px; box-shadow:0 8px 24px rgba(99,102,241,.35);
    }
    .btn:hover{ filter:brightness(1.03); }
    .btn-ghost{ background:transparent; border:1px solid #334155; color:#e5e7eb; box-shadow:none; }
    .pill{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #334155;display:inline-flex;align-items:center;gap:6px;}
    .pill-ok{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.3); color:#0bb37b;}
    .pill-err{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35); color:#ef4444;}
    .chat-input { background:#ffffff; color:#111827; border:1px solid #e5e7eb; }
    code { background:#0b1220; padding:2px 6px; border-radius:6px; border:1px solid #1f2937; }
  </style>
</head>
<body class="min-h-screen bg-gray-100 text-gray-100 flex">

  <!-- Sidebar -->
  <aside class="w-64 bg-white text-gray-800 shadow-lg p-6 hidden md:block">
    <h2 class="text-xl font-bold mb-6">ğŸ“‚ ×”××•×˜×•××¦×™×•×ª ×©×œ×™</h2>
    <ul class="space-y-3">
      <li class="p-3 bg-blue-100 text-blue-700 rounded-lg font-medium">××•×˜×•××¦×™×” ×—×“×©×”</li>
      <li class="p-3 hover:bg-gray-100 rounded-lg cursor-pointer">SLA ××™×™×œ×™×</li>
      <li class="p-3 hover:bg-gray-100 rounded-lg cursor-pointer">×¡×™×›×•× ×¤×’×™×©×•×ª</li>
      <li class="p-3 hover:bg-gray-100 rounded-lg cursor-pointer">×”×–× ×•×ª ×œ-Google Sheets</li>
    </ul>

    <div class="mt-8 space-y-2">
      <button id="btn-debug-nlp" class="w-full btn-ghost rounded-lg py-2">×‘×“×™×§×ª NLP</button>
    </div>
  </aside>

  <!-- Main -->
  <section class="flex-1">
    <header class="px-6 py-4 border-b border-slate-800 flex items-center justify-between">
      <h1 class="text-xl font-bold">Wizard Plus</h1>
      <div class="flex items-center gap-2">
        <span id="g-status" class="pill pill-err">×œ× ××—×•×‘×¨</span>
        <span id="g-email" class="pill hidden"></span>
        <button id="btn-g-connect" class="btn">×”×ª×—×‘×¨ ×œ×’×•×’×œ</button>
        <button id="btn-g-disconnect" class="btn-ghost hidden">×”×ª× ×ª×§</button>
      </div>
    </header>

    <main class="p-6 space-y-4">
      <div id="chat" class="space-y-3">
        <div class="bubble fade-in">
          ×›×ª×‘×• ×‘×©×¤×” ×—×•×¤×©×™×ª ××” ×ª×¨×¦×• ×©××¢×©×” ×¢×‘×•×¨×›×. ×× ×™ ××‘×§×© ×¤×¨×˜×™× ×©×—×¡×¨×™× ×•××– ××¨×™×¥ ××•×˜×•××¦×™×”.
        </div>
      </div>

      <!-- ×©×•×¨×ª ×”×§×œ×˜ -->
      <div class="flex gap-2">
        <input id="free-text" class="flex-1 chat-input rounded-xl px-3 py-3" placeholder="×œ××©×œ: ××™×™×œ×™× ××—×•×“×© ××—×¨×•×Ÿ ×××™×›×œ ×©×œ× × ×¢× ×• 10 ×©×¢×•×ª â†’ ×”×›× ×¡ ×œ-SLA" />
        <button id="btn-plan" class="btn">×ª×›× ×Ÿ</button>
        <button id="btn-run" class="btn" disabled>×”×¨×¥</button>
      </div>

      <!-- ×©×“×•×ª ×—×¡×¨×™× -->
      <div id="missing-fields" class="grid gap-2 md:grid-cols-2"></div>
    </main>
  </section>

  <script>
    // ===== Elements =====
    const chat = document.getElementById('chat');
    const freeText = document.getElementById('free-text');
    const btnPlan = document.getElementById('btn-plan');
    const btnRun = document.getElementById('btn-run');
    const missingFields = document.getElementById('missing-fields');

    const gStatus = document.getElementById('g-status');
    const gEmail  = document.getElementById('g-email');
    const btnConnect = document.getElementById('btn-g-connect');
    const btnDisconnect = document.getElementById('btn-g-disconnect');

    let lastPlan = null;
    let lastMissing = [];
    let lastText = "";

    function addBubble(text, who='bot') {
      const div = document.createElement('div');
      div.className = 'bubble fade-in' + (who==='user' ? ' user' : '');
      div.innerHTML = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function renderMissing(missing) {
      missingFields.innerHTML = '';
      (missing || []).forEach(m => {
        const wrap = document.createElement('div');
        wrap.className = 'space-y-1';
        wrap.innerHTML = `
          <label class="text-sm opacity-80">${m.label || m.key}</label>
          <input class="chat-input w-full rounded-xl px-3 py-2" data-key="${m.key}" placeholder="${m.example || ''}" />
        `;
        missingFields.appendChild(wrap);
      });
    }

    function setGoogleUI(connected, email) {
      if (connected) {
        gStatus.textContent = '××—×•×‘×¨';
        gStatus.classList.remove('pill-err'); gStatus.classList.add('pill-ok');
        gEmail.textContent = email || '';
        gEmail.classList.toggle('hidden', !email);
        btnConnect.classList.add('hidden');
        btnDisconnect.classList.remove('hidden');
      } else {
        gStatus.textContent = '×œ× ××—×•×‘×¨';
        gStatus.classList.add('pill-err'); gStatus.classList.remove('pill-ok');
        gEmail.classList.add('hidden'); gEmail.textContent = '';
        btnConnect.classList.remove('hidden');
        btnDisconnect.classList.add('hidden');
      }
    }

    async function refreshGoogleAccount() {
      let justConnected = false;
      if (location.hash.includes('connected=1')) {
        justConnected = true;
        setGoogleUI(true); // ×—×™×•×•×™ ××™×™×“×™
      }
      try {
        const r1 = await fetch('/api/google/auth/status');
        if (r1.ok) {
          const s = await r1.json();
          if (s?.ok && s.hasRefreshToken) {
            try {
              const r2 = await fetch('/api/google/me');
              const j2 = await r2.json();
              if (j2.ok) setGoogleUI(true, j2.emailAddress);
              else setGoogleUI(true);
            } catch { setGoogleUI(true); }
            if (justConnected) location.hash = '';
            return;
          }
        }
      } catch {}
      try {
        const r = await fetch('/api/google/me');
        const j = await r.json();
        setGoogleUI(!!j.ok, j.emailAddress);
      } catch {
        if (!justConnected) setGoogleUI(false);
      }
      if (justConnected) location.hash = '';
    }

    btnConnect.onclick = async () => {
      try {
        const r = await fetch('/api/google/oauth/url');
        const j = await r.json();
        if (j.ok && j.url) window.location.href = j.url;
        else addBubble('âŒ ×œ× ×”×¦×œ×—×ª×™ ×œ×§×‘×œ ×§×™×©×•×¨ ×”×ª×—×‘×¨×•×ª');
      } catch {
        addBubble('âŒ ×©×’×™××” ×‘×§×™×©×•×¨ ×”×ª×—×‘×¨×•×ª ×œ×’×•×’×œ');
      }
    };
    btnDisconnect.onclick = async () => {
      try { await fetch('/api/google/logout', { method:'POST' }); } finally { refreshGoogleAccount(); }
    };

    btnPlan.onclick = async () => {
      const text = (freeText.value || '').trim();
      if (!text) return;
      addBubble(text, 'user');
      btnPlan.disabled = true;

      try {
        const res = await fetch('/api/plan/from-text', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text })
        });
        const j = await res.json();
        if (!j.ok) throw new Error(j.error || 'PLAN_FAILED');
        lastPlan = j.proposal || [];
        lastMissing = j.missing || [];
        lastText = text;

        if (lastMissing.length) {
          addBubble('×¦×¨×™×š ×œ×”×©×œ×™× ×›××” ×¤×¨×˜×™×â€”××œ××• ×œ××˜×” ×•××– ×œ×—×¦×• "×”×¨×¥".');
          renderMissing(lastMissing);
          btnRun.disabled = false;
        } else {
          addBubble('××¢×•×œ×” â€” ××¤×©×¨ ×œ×”×¨×™×¥.');
          btnRun.disabled = false;
        }
      } catch (e) {
        console.error(e);
        addBubble('âŒ ×©×’×™××” ×‘×ª×›× ×•×Ÿ');
      } finally {
        btnPlan.disabled = false;
      }
    };

    btnRun.onclick = async () => {
      btnRun.disabled = true;

      const filled = {};
      missingFields.querySelectorAll('input[data-key]').forEach(inp => {
        filled[inp.dataset.key] = inp.value.trim();
      });

      const steps = (lastPlan || []).map(s => {
        const copy = JSON.parse(JSON.stringify(s));
        if (copy.trigger?.params) {
          for (const k of Object.keys(copy.trigger.params)) if (filled[k]) copy.trigger.params[k] = filled[k];
        }
        if (copy.action?.params) {
          for (const k of Object.keys(copy.action.params)) if (filled[k]) copy.action.params[k] = filled[k];
        }
        return copy;
      });

      try {
        const res = await fetch('/api/automations/execute', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text: lastText, steps })
        });
        const j = await res.json();
        if (!j.ok) {
          if (j.error === 'MISSING_FIELDS') {
            renderMissing(j.missing || []);
            addBubble('×¢×•×“ ×›××” ×¤×¨×˜×™× ×—×¡×¨×™×â€”××œ××• ×•×”×¤×¢×™×œ×• ×©×•×‘.');
            btnRun.disabled = false;
            return;
          }
          throw new Error(j.error || 'EXECUTION_FAILED');
        }
        addBubble('âœ… ×‘×•×¦×¢! ×‘×“×§×• ××ª ×”×™×¢×“ (×œ××©×œ Google Sheet).');
      } catch (e) {
        console.error(e);
        addBubble('âŒ ×©×’×™××” ×‘×”×¨×¦×”');
      }
    };

    document.getElementById('btn-debug-nlp').onclick = async () => {
      const text = (freeText.value || '').trim();
      if (!text) { addBubble('âŒ ×›×ª×•×‘ ××˜×¨×” ×—×•×¤×©×™×ª ×‘×ª×™×‘×” ×œ××¢×œ×”'); return; }
      addBubble('ğŸ” ××¨×™×¥ /api/plan/from-textâ€¦');
      try {
        const res = await fetch('/api/plan/from-text', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text })
        });
        const j = await res.json();
        const pretty = `<pre class="text-xs mt-2"><code>${JSON.stringify(j, null, 2)
          .replace(/</g,'&lt;').replace(/>/g,'&gt;')}</code></pre>`;
        addBubble(`Intent: <code>${(j.nlp && j.nlp.intent) || 'â€”'}</code> Â· Provider: <code>${j.provider || 'â€”'}</code>${pretty}`);
      } catch {
        addBubble('âŒ ×©×’×™××ª ×‘×“×™×§×ª ×ª×›× ×•×Ÿ');
      }
    };

    refreshGoogleAccount();
  </script>
</body>
</html>
