<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Wizard Plus â€” Chat UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#0b1020; }
    .fade-in { animation: fadein .4s ease; }
    @keyframes fadein { from {opacity:0; transform: translateY(6px)} to {opacity:1; transform:none} }
    .bubble{ background:#0b1323; border:1px solid #273244; color:#e5e7eb; border-radius:12px; padding:12px 14px; }
    .bubble.user{ background:#121a2b; }
    .btn {
      appearance:none; border:none !important; border-radius:12px; padding:12px 16px;
      background:linear-gradient(135deg,#6366f1,#8b5cf6) !important; color:#fff !important;
      cursor:pointer; font-weight:700; letter-spacing:.3px; box-shadow:0 8px 24px rgba(99,102,241,.35);
    }
    .btn:hover{ filter:brightness(1.03); }
    .btn-ghost{
      background:transparent !important; border:1.5px solid #6d28d9 !important; color:#6d28d9 !important;
      border-radius:12px; padding:10px 14px; font-weight:700;
    }
    .pill{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #334155;display:inline-flex;align-items:center;gap:6px;}
    .pill-ok{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.3); color:#0bb37b;}
    .pill-err{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35); color:#ef4444;}
    .chat-input { background:#ffffff; color:#111827; border:1px solid #e5e7eb; }
    code { background:#0b1220; padding:2px 6px; border-radius:6px; border:1px solid #1f2937; }
    .help { color:#cbd5e1; font-size:13px; }
    .menu-item { padding:10px 12px; border-radius:10px; cursor:pointer; border:1px solid #e5e7eb; background:#fff; color:#334155; }
    .menu-item:hover { background:#f5f5ff; border-color:#c7d2fe; }
    .menu-title { font-weight:700; margin-bottom:4px; }
    .menu-desc { font-size:12px; opacity:.75; }
  </style>
</head>
<body class="min-h-screen text-gray-100 flex">

  <!-- Sidebar -->
  <aside class="w-72 bg-white text-gray-800 shadow-lg p-6 space-y-6 hidden md:block">
    <div>
      <h2 class="text-xl font-bold mb-3">ğŸš€ ××•×˜×•××¦×™×•×ª ××•×¦×¢×•×ª</h2>
      <div class="space-y-2">
        <div class="menu-item" data-template="two-senders-to-sheet">
          <div class="menu-title">×˜×‘×œ×” ××©×•×ª×¤×ª ×œ×©× ×™ ×©×•×œ×—×™×</div>
          <div class="menu-desc">×›×©×”× ×©×•×œ×—×™× ××™×™×œ â†’ ×”×•×¡×¤×ª ×©×•×¨×” (×©×•×œ×—, ×ª××¨×™×š, × ×•×©×, ×ª×•×›×Ÿ)</div>
        </div>
        <div class="menu-item" data-template="unreplied-to-sheet">
          <div class="menu-title">××™×™×œ×™× ×œ× × ×¢× ×• â†’ ×’×™×œ×™×•×Ÿ</div>
          <div class="menu-desc">×–×™×”×•×™ ×—×•×˜×™× ×©×œ× × ×¢× ×• X ×©×¢×•×ª â†’ ×¨×©×•××” ×‘Ö¾Google Sheet</div>
        </div>
        <div class="menu-item" data-template="sheet-match-to-email">
          <div class="menu-title">×¢×¨×š ×‘×¢××•×“×” â†’ ××™×™×œ</div>
          <div class="menu-desc">×›×©×”×ª×•×•×¡×£ ×¢×¨×š ××¡×•×™× ×‘×¢××•×“×” ×¡×¤×¦×™×¤×™×ª â†’ ×©×œ×™×—×ª ××™××™×™×œ</div>
        </div>
        <div class="menu-item" data-template="unreplied-to-whatsapp">
          <div class="menu-title">××™×™×œ×™× ×œ× × ×¢× ×• â†’ WhatsApp</div>
          <div class="menu-desc">SLA: ×”×•×“×¢×ª ×•×•××˜×¡××¤ ×¢× ×§×™×©×•×¨ ×œ×©×™×—×”</div>
        </div>
      </div>
    </div>

    <div>
      <h2 class="text-xl font-bold mb-3">ğŸ“‚ ×”××•×˜×•××¦×™×•×ª ×©×œ×™</h2>
      <div id="my-autos" class="space-y-2 text-sm">
        <div class="opacity-60">â€” ××™×Ÿ ×¢×“×™×™×Ÿ ×©××•×¨×•×ª â€”</div>
      </div>
    </div>

    <div class="space-y-2">
      <button id="btn-debug-nlp" class="w-full btn-ghost rounded-lg">×‘×“×™×§×ª NLP</button>
    </div>
  </aside>

  <!-- Main -->
  <section class="flex-1">
    <header class="px-6 py-4 border-b border-slate-800 flex items-center justify-between">
      <h1 class="text-xl font-bold">Wizard Plus</h1>
      <div class="flex items-center gap-2">
        <span id="g-status" class="pill pill-err">×œ× ××—×•×‘×¨</span>
        <span id="g-email" class="pill hidden"></span>
        <button id="btn-g-connect" class="btn">×”×ª×—×‘×¨ ×œ×’×•×’×œ</button>
        <button id="btn-g-disconnect" class="btn-ghost hidden">×”×ª× ×ª×§</button>
      </div>
    </header>

    <main class="p-6 space-y-4">
      <div id="chat" class="space-y-3">
        <div class="bubble fade-in">
          ×›×ª×‘×• ×‘×©×¤×” ×—×•×¤×©×™×ª ××” ×ª×¨×¦×• ×©××¢×©×” ×¢×‘×•×¨×›×. ×× ×™ ××‘×§×© ×¤×¨×˜×™× ×©×—×¡×¨×™× ×•××– ××¨×™×¥ ××•×˜×•××¦×™×”.
        </div>
      </div>

      <div class="flex gap-2">
        <input id="free-text" class="flex-1 chat-input rounded-xl px-3 py-3"
               placeholder="×œ××©×œ: ×˜×‘×œ×” ××©×•×ª×¤×ª ×œ×©× ×™ ×× ×©×™×; ×›×œ ×¤×¢× ×©××—×“ ××”× ×©×•×œ×— ××™×™×œâ€”×œ×”×•×¡×™×£ ×©×•×¨×” ×¢× ×”×©×•×œ×—/× ×•×©×/×ª××¨×™×š/×ª×•×›×Ÿ" />
        <button id="btn-plan" class="btn">×ª×›× ×Ÿ</button>
        <button id="btn-run" class="btn" disabled>×”×¨×¥</button>
        <button id="btn-save" class="btn-ghost" disabled>×©××•×¨ ×›××•×˜×•××¦×™×”</button>
      </div>

      <div id="missing-intro" class="help hidden"></div>
      <div id="missing-fields" class="grid gap-2 md:grid-cols-2"></div>
    </main>
  </section>

  <script>
    // ===== Elements =====
    const chat = document.getElementById('chat');
    const freeText = document.getElementById('free-text');
    const btnPlan = document.getElementById('btn-plan');
    const btnRun = document.getElementById('btn-run');
    const btnSave = document.getElementById('btn-save');
    const missingFields = document.getElementById('missing-fields');
    const missingIntro = document.getElementById('missing-intro');

    const gStatus = document.getElementById('g-status');
    const gEmail  = document.getElementById('g-email');
    const btnConnect = document.getElementById('btn-g-connect');
    const btnDisconnect = document.getElementById('btn-g-disconnect');

    const myAutos = document.getElementById('my-autos');

    let lastPlan = null;
    let lastMissing = [];
    let lastText = "";
    let draftSteps = null; // steps after filling missing

    // ===== Chat helpers =====
    function addBubble(text, who='bot') {
      const div = document.createElement('div');
      div.className = 'bubble fade-in' + (who==='user' ? ' user' : '');
      div.innerHTML = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function renderMissing(missing) {
      missingFields.innerHTML = '';
      (missing || []).forEach(m => {
        const wrap = document.createElement('div');
        wrap.className = 'space-y-1';
        wrap.innerHTML = `
          <label class="text-sm opacity-80">${m.label || m.key}</label>
          <input class="chat-input w-full rounded-xl px-3 py-2" data-key="${m.key}" placeholder="${m.example || ''}" />
        `;
        missingFields.appendChild(wrap);
      });
      updateMissingHelp(missing || []);
      const first = missingFields.querySelector('input[data-key]');
      if (first) first.focus();
    }

    function updateMissingHelp(missing) {
      if (!missing.length) { missingIntro.classList.add('hidden'); missingIntro.textContent = ''; return; }
      const keys = missing.map(m => m.key);
      if (keys.includes('to')) {
        missingIntro.textContent = '××œ××• ××ª ×›×ª×•×‘×ª ×”××™×™×œ (×œ×©×œ×™×—×”).';
      } else if (keys.includes('spreadsheetId')) {
        missingIntro.textContent = '××¤×©×¨ ×œ×”×“×‘×™×§ ××ª ×›×œ ×§×™×©×•×¨ ×”×’×™×œ×™×•×Ÿ â€” × ×•×¦×™× ××ª ×”-ID ×œ×‘×“.';
      } else if (keys.includes('fromEmails')) {
        missingIntro.textContent = '×”×–×™× ×• ×›××” ×›×ª×•×‘×•×ª ××™×™×œ ××•×¤×¨×“×•×ª ×‘×¤×¡×™×§: name1@ex.com, name2@ex.com';
      } else if (keys.includes('fromEmail')) {
        missingIntro.textContent = '×›×ª×•×‘×ª ×”××™×™×œ ×©×œ ×”×©×•×œ×— ×©××•×ª×• ×‘×•×“×§×™×.';
      } else {
        missingIntro.textContent = '××œ××• ××ª ×”×¤×¨×˜×™× ×”×—×¡×¨×™× ×•×œ×—×¦×• "×”×¨×¥".';
      }
      missingIntro.classList.remove('hidden');
    }

    // ===== Google auth UI =====
    function setGoogleUI(connected, email) {
      if (connected) {
        gStatus.textContent = '××—×•×‘×¨';
        gStatus.classList.remove('pill-err'); gStatus.classList.add('pill-ok');
        gEmail.textContent = email || '';
        gEmail.classList.toggle('hidden', !email);
        btnConnect.classList.add('hidden');
        btnDisconnect.classList.remove('hidden');
      } else {
        gStatus.textContent = '×œ× ××—×•×‘×¨';
        gStatus.classList.add('pill-err'); gStatus.classList.remove('pill-ok');
        gEmail.classList.add('hidden'); gEmail.textContent = '';
        btnConnect.classList.remove('hidden');
        btnDisconnect.classList.add('hidden');
      }
    }
    async function refreshGoogleAccount() {
      let justConnected = false;
      if (location.hash.includes('connected=1')) justConnected = true;

      try {
        const r1 = await fetch('/api/google/auth/status');
        const s = r1.ok ? await r1.json() : null;
        if (s?.ok && s.hasRefreshToken) {
          try {
            const r2 = await fetch('/api/google/me');
            const j2 = await r2.json();
            if (j2.ok) setGoogleUI(true, j2.emailAddress); else setGoogleUI(true);
          } catch { setGoogleUI(true); }
          if (justConnected) location.hash = '';
          return;
        }
      } catch {}

      try {
        const r = await fetch('/api/google/me');
        const j = await r.json();
        setGoogleUI(!!j.ok, j.emailAddress);
      } catch { setGoogleUI(false); }

      if (justConnected) location.hash = '';
    }
    btnConnect.onclick = async () => {
      try {
        const r = await fetch('/api/google/oauth/url');
        const j = await r.json();
        if (j.ok && j.url) window.location.href = j.url;
        else addBubble('âŒ ×œ× ×”×¦×œ×—×ª×™ ×œ×§×‘×œ ×§×™×©×•×¨ ×”×ª×—×‘×¨×•×ª');
      } catch {
        addBubble('âŒ ×©×’×™××” ×‘×§×™×©×•×¨ ×”×ª×—×‘×¨×•×ª ×œ×’×•×’×œ');
      }
    };
    btnDisconnect.onclick = async () => {
      try { await fetch('/api/google/logout', { method:'POST' }); } finally { refreshGoogleAccount(); }
    };

    // ===== Suggested templates (sidebar) =====
    const templateTexts = {
      "two-senders-to-sheet":
        "×× ×™ ×¨×•×¦×” ×œ×‘× ×•×ª ×˜×‘×œ×” ××©×•×ª×¤×ª ×œ×©× ×™ ×× ×©×™×; ×›×œ ×¤×¢× ×©××—×“ ××”× ×©×•×œ×— ××™×™×œâ€”×œ×”×•×¡×™×£ ×©×•×¨×” ×¢× ×”×©×•×œ×—, ×”×ª××¨×™×š, ×”× ×•×©×, ×•×”×ª×•×›×Ÿ.",
      "unreplied-to-sheet":
        "×›×œ ××™×™×œ ××œ×§×•×— ××¡×•×™× ×©×œ× × ×¢× ×” ×‘××©×š 10 ×©×¢×•×ª ×‘-30 ×™××™× ×”××—×¨×•× ×™×â€”×œ×”×•×¡×™×£ ×¨×©×•××” ×‘×’×™×œ×™×•×Ÿ Google.",
      "sheet-match-to-email":
        "×›×©×”×ª×•×•×¡×£ ×¢×¨×š ××¡×•×™× ×‘×¢××•×“×” ××¡×•×™××ª ×‘×’×™×œ×™×•×Ÿâ€”×©×œ×— ××™××™×™×œ ×¢× ×›×œ ×”×©×•×¨×”.",
      "unreplied-to-whatsapp":
        "××™×™×œ×™× ×©×œ× × ×¢× ×• ×‘××©×š 10 ×©×¢×•×ª ×‘-30 ×™××™× ×”××—×¨×•× ×™×â€”×©×œ×— ×”×•×“×¢×ª WhatsApp ×¢× × ×•×©× ×•×§×™×©×•×¨ ×œ×©×™×—×”."
    };

    document.querySelectorAll('.menu-item[data-template]').forEach(el => {
      el.addEventListener('click', async () => {
        const key = el.getAttribute('data-template');
        const text = templateTexts[key] || '';
        if (!text) return;
        freeText.value = text;
        await doPlan(text);
      });
    });

    // ===== NLP Planning =====
    async function doPlan(text) {
      addBubble(text, 'user');
      btnPlan.disabled = true;
      try {
        const res = await fetch('/api/plan/from-text', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text })
        });
        const j = await res.json();
        if (!j.ok) throw new Error(j.error || 'PLAN_FAILED');

        lastPlan = j.proposal || [];
        lastMissing = j.missing || [];
        lastText = text;

        if (Array.isArray(j.questions) && j.questions.length) {
          j.questions.forEach(q => addBubble('â“ ' + q));
        }

        if (lastMissing.length) {
          addBubble('×¦×¨×™×š ×œ×”×©×œ×™× ×›××” ×¤×¨×˜×™×â€”××œ××• ×œ××˜×” ×•××– ×œ×—×¦×• "×”×¨×¥".');
          renderMissing(lastMissing);
          btnRun.disabled = false;
          btnSave.disabled = true; // × ×©××•×¨ ××—×¨×™ ××™×œ×•×™
        } else if (lastPlan.length) {
          addBubble('××¢×•×œ×” â€” ××¤×©×¨ ×œ×”×¨×™×¥.');
          missingFields.innerHTML = ''; updateMissingHelp([]);
          btnRun.disabled = false;
          btnSave.disabled = false;
        } else {
          addBubble('×œ× ×–×•×”×ª×” ×›×•×•× ×”. × ×¡×• ×œ× ×¡×— ××—×¨×ª ××• ×œ×‘×—×•×¨ ××•×˜×•××¦×™×” ××•×¦×¢×ª.');
        }
      } catch (e) {
        console.error(e);
        addBubble('âŒ ×©×’×™××” ×‘×ª×›× ×•×Ÿ');
      } finally {
        btnPlan.disabled = false;
      }
    }

    btnPlan.onclick = async () => {
      const text = (freeText.value || '').trim();
      if (!text) return;
      await doPlan(text);
    };

    // ===== Execute =====
    btnRun.onclick = async () => {
      btnRun.disabled = true;

      const filled = {};
      missingFields.querySelectorAll('input[data-key]').forEach(inp => {
        const k = inp.dataset.key;
        let v = inp.value.trim();
        filled[k] = v;
      });

      const steps = (lastPlan || []).map(s => {
        const copy = JSON.parse(JSON.stringify(s));
        if (copy.trigger?.params) {
          for (const k of Object.keys(copy.trigger.params)) if (filled[k]) copy.trigger.params[k] = filled[k];
        }
        if (copy.action?.params) {
          for (const k of Object.keys(copy.action.params)) if (filled[k]) copy.action.params[k] = filled[k];
        }
        return copy;
      });
      draftSteps = steps;

      try {
        const res = await fetch('/api/automations/execute', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text: lastText, steps })
        });
        const j = await res.json();
        if (!j.ok) {
          if (j.error === 'MISSING_FIELDS') {
            renderMissing(j.missing || []);
            addBubble('×¢×•×“ ×›××” ×¤×¨×˜×™× ×—×¡×¨×™×â€”××œ××• ×•×”×¤×¢×™×œ×• ×©×•×‘.');
            btnRun.disabled = false;
            return;
          }
          throw new Error(j.error || 'EXECUTION_FAILED');
        }
        addBubble('âœ… ×‘×•×¦×¢! ×‘×“×§×• ××ª ×”×™×¢×“ (Email / WhatsApp / Sheet).');
        missingFields.innerHTML = ''; updateMissingHelp([]);
        btnSave.disabled = false; // ×¢×›×©×™×• ××¤×©×¨ ×œ×©××•×¨ ×›××•×˜×•××¦×™×”
      } catch (e) {
        console.error(e);
        addBubble('âŒ ×©×’×™××” ×‘×”×¨×¦×”');
      }
    };

    // ===== Save automation (per user) =====
    function slugify(s='') {
      return s.toLowerCase().trim()
        .replace(/[^\w\s\u0590-\u05FF-]/g,'')
        .replace(/\s+/g,'-').slice(0,50) || ('auto-' + Math.random().toString(36).slice(2,8));
    }

    btnSave.onclick = async () => {
      if (!draftSteps && (!lastPlan || !lastPlan.length)) {
        addBubble('××™×Ÿ ××” ×œ×©××•×¨ ×›×¨×’×¢. ×”×¨×¥ ××• ×ª×›× ×Ÿ ×§×•×“×.');
        return;
      }
      const title = prompt('×©× ×œ××•×˜×•××¦×™×”:', '××•×˜×•××¦×™×” ×—×“×©×”');
      if (!title) return;
      const id = slugify(title);

      const steps = draftSteps?.length ? draftSteps : lastPlan;

      try {
        const res = await fetch('/api/automations/save', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id, title, text: lastText, steps })
        });
        const j = await res.json();
        if (j.ok) {
          addBubble(`ğŸ’¾ × ×©××¨ ×‘×©× <code>${title}</code>.`);
          loadMyAutos();
        } else {
          addBubble('âŒ ×©×’×™××” ×‘×©××™×¨×”');
        }
      } catch {
        addBubble('âŒ ×©×’×™××” ×‘×©××™×¨×”');
      }
    };

    async function loadMyAutos() {
      myAutos.innerHTML = '<div class="opacity-60">×˜×•×¢×Ÿâ€¦</div>';
      try {
        const r = await fetch('/api/automations/list');
        const j = await r.json();
        if (!j.ok) throw new Error();
        if (!j.items.length) {
          myAutos.innerHTML = '<div class="opacity-60">â€” ××™×Ÿ ×¢×“×™×™×Ÿ ×©××•×¨×•×ª â€”</div>';
          return;
        }
        myAutos.innerHTML = '';
        j.items.sort((a,b)=>b.updatedAt-a.updatedAt).forEach(a => {
          const row = document.createElement('div');
          row.className = 'menu-item';
          row.innerHTML = `
            <div class="menu-title">${a.title || a.id}</div>
            <div class="menu-desc">${(a.text||'').slice(0,90)}</div>
            <div class="mt-2 flex gap-2">
              <button class="btn-ghost px-3 py-2" data-run="${a.id}">×”×¨×¥</button>
              <button class="btn-ghost px-3 py-2" data-delete="${a.id}">××—×§</button>
            </div>
          `;
          myAutos.appendChild(row);

          row.querySelector(`[data-run="${a.id}"]`).onclick = async () => {
            try {
              const res = await fetch('/api/automations/execute-saved', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ id: a.id })
              });
              const j = await res.json();
              if (j.ok) addBubble(`â–¶ï¸ ×”×•×¤×¢×œ×”: <code>${a.title || a.id}</code>`);
              else addBubble('âŒ ×©×’×™××” ×‘×”×¨×¦×”');
            } catch { addBubble('âŒ ×©×’×™××” ×‘×”×¨×¦×”'); }
          };
          row.querySelector(`[data-delete="${a.id}"]`).onclick = async () => {
            if (!confirm('×œ××—×•×§ ××ª ×”××•×˜×•××¦×™×”?')) return;
            try {
              const res = await fetch('/api/automations/' + a.id, { method:'DELETE' });
              const j2 = await res.json();
              if (j2.ok) { loadMyAutos(); addBubble('ğŸ—‘ï¸ × ××—×§'); } else addBubble('âŒ ×©×’×™××” ×‘××—×™×§×”');
            } catch { addBubble('âŒ ×©×’×™××” ×‘××—×™×§×”'); }
          };
        });
      } catch {
        myAutos.innerHTML = '<div class="text-red-600">âŒ ×©×’×™××” ×‘×˜×¢×™× ×”</div>';
      }
    }

    // ===== Debug NLP =====
    document.getElementById('btn-debug-nlp').onclick = async () => {
      const text = (freeText.value || '').trim();
      if (!text) { addBubble('âŒ ×›×ª×•×‘ ××˜×¨×” ×—×•×¤×©×™×ª ×‘×ª×™×‘×” ×œ××¢×œ×”'); return; }
      addBubble('ğŸ” ××¨×™×¥ /api/plan/from-textâ€¦');
      try {
        const res = await fetch('/api/plan/from-text', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text })
        });
        const j = await res.json();
        const pretty = `<pre class="text-xs mt-2"><code>${JSON.stringify(j, null, 2)
          .replace(/</g,'&lt;').replace(/>/g,'&gt;')}</code></pre>`;
        addBubble(`Intent: <code>${(j.nlp && j.nlp.intent) || 'â€”'}</code> Â· Provider: <code>${j.provider || 'â€”'}</code>${pretty}`);
      } catch { addBubble('âŒ ×©×’×™××ª ×‘×“×™×§×ª ×ª×›× ×•×Ÿ'); }
    };

    // init
    refreshGoogleAccount().then(loadMyAutos);
  </script>
</body>
</html>
