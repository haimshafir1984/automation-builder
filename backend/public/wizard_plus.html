<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Automation Builder · Wizard+</title>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171a21;
      --muted: #9aa3b2;
      --text: #e6edf3;
      --primary: #4cc38a;
      --danger: #ff6b6b;
      --warning: #f5a524;
      --border: #2a2f3a;
      --accent: #7c86ff;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      background: radial-gradient(1200px 600px at 90% -20%, #1a1f2e 0%, transparent 60%), var(--bg);
      color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    h1 { margin: 0 0 8px; font-size: 28px; }
    .sub { color: var(--muted); margin-bottom: 24px; }
    .grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 20px; align-items: start; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: 14px; padding: 18px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.03);
    }
    .card h2 { margin: 0 0 10px; font-size: 18px; }
    label { display: block; font-size: 14px; color: var(--muted); margin: 12px 0 6px; }
    input[type="text"], input[type="number"], textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
      background: #0c0f14; color: var(--text); font-size: 14px; outline: none;
    }
    textarea { min-height: 110px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      background: linear-gradient(180deg, #3dd68c, #12a773);
      color: #061a11; border: none; font-weight: 700;
      padding: 10px 14px; border-radius: 10px; cursor: pointer;
      box-shadow: 0 6px 18px rgba(60, 214, 140, 0.25);
    }
    .btn.secondary {
      background: linear-gradient(180deg, #7c86ff, #4c57ff);
      color: #fff; box-shadow: 0 6px 18px rgba(124, 134, 255, 0.25);
    }
    .btn.ghost { background: transparent; color: var(--text); border: 1px solid var(--border); }
    .btn.danger { background: linear-gradient(180deg, #ff8b8b, #ff5a5a); color: #210b0b; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .muted { color: var(--muted); font-size: 13px; }
    .mono { font-family: var(--mono); font-size: 12px; }
    pre {
      background: #0c0f14; border: 1px solid var(--border); border-radius: 10px; padding: 12px;
      overflow: auto; max-height: 320px; white-space: pre-wrap; word-break: break-word;
    }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); background:#10141c; }
    .ok { color: var(--primary); }
    .warn { color: var(--warning); }
    .bad { color: var(--danger); }
    .hr { height:1px; background: var(--border); margin: 14px 0; }
    .footer { margin-top: 18px; display:flex; gap: 10px; flex-wrap: wrap; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .stack { display:flex; flex-direction: column; gap:8px; }
    .flex { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .hide { display:none; }
  </style>
</head>
<body>
  <header class="stack">
    <h1>🔧 Automation Builder — Wizard+</h1>
    <div class="sub">הגדר אוטומציה בשפת טבעית, קבל תכנון, Dry-Run, ואז הרצה מלאה—ישירות מהדפדפן.</div>
  </header>

  <section class="grid">
    <!-- עמודת האשף -->
    <div class="card">
      <h2>1) התחברות לגוגל</h2>
      <div class="flex">
        <button id="btnGoogle" class="btn">התחבר עם גוגל</button>
        <button id="btnStatus" class="btn ghost">בדיקת סטטוס</button>
        <span id="oauthPill" class="pill muted">ממתין...</span>
      </div>
      <div class="muted mono" id="oauthInfo"></div>
      <div class="hr"></div>

      <h2>2) תיאור האוטומציה (טקסט חופשי)</h2>
      <label for="freeText">תאר במילים פשוטות מה תרצה (לדוגמה: “כל מייל מ־foo@bar.com שלא נענה 4 שעות → הוסף ל־Google Sheets”)</label>
      <textarea id="freeText" placeholder="כתבו כאן את הדרישה שלכם..."></textarea>

      <div class="footer">
        <button id="btnPlan" class="btn secondary">הכנת תכנון (NLP → /api/plan)</button>
        <button id="btnDryRun" class="btn">Dry-Run</button>
        <button id="btnExecute" class="btn danger">הרצה (Execute)</button>
      </div>
      <div class="muted">* התהליך: תכנון → Dry-Run (לא כותב בפועל) → Execute (מריץ על אמת).</div>
    </div>

    <!-- עמודת פרטים/תוצאה -->
    <div class="card">
      <h2>פרטים משלימים (אם חסר ב־plan)</h2>

      <div class="row">
        <div>
          <label for="fromEmail">כתובת שולח (fromEmail)</label>
          <input id="fromEmail" type="text" placeholder="foo@bar.com" />
        </div>
        <div>
          <label for="hours">שעות SLA (hours)</label>
          <input id="hours" type="number" min="1" max="72" step="1" placeholder="4" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="spreadsheetId">Spreadsheet ID</label>
          <input id="spreadsheetId" type="text" placeholder="1AbCDefGhIjkLmNoP..." />
        </div>
        <div>
          <label for="tabName">Tab / Sheet name</label>
          <input id="tabName" type="text" placeholder="SLA" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="limit">Limit</label>
          <input id="limit" type="number" min="1" step="1" placeholder="50" />
        </div>
        <div>
          <label for="newerThanDays">Newer Than (days)</label>
          <input id="newerThanDays" type="number" min="1" step="1" placeholder="30" />
        </div>
      </div>

      <div class="hr"></div>
      <h2>פלט וניטור</h2>
      <div class="stack">
        <div class="mono muted" id="hintsBox">Hints: —</div>
        <pre id="resultBox">מוכן.</pre>
      </div>
    </div>
  </section>

  <script>
    const $ = (id) => document.getElementById(id);
    const oauthPill = $("oauthPill");
    const oauthInfo = $("oauthInfo");
    const resultBox = $("resultBox");
    const hintsBox  = $("hintsBox");

    const input = {
      freeText: $("freeText"),
      fromEmail: $("fromEmail"),
      hours: $("hours"),
      spreadsheetId: $("spreadsheetId"),
      tabName: $("tabName"),
      limit: $("limit"),
      newerThanDays: $("newerThanDays"),
    };

    function show(obj, title = "") {
      const txt = (title ? title + "\n" : "") + JSON.stringify(obj, null, 2);
      resultBox.textContent = txt;
    }
    function setPill(txt, cls = "") {
      oauthPill.textContent = txt;
      oauthPill.classList.remove("ok", "bad", "warn");
      if (cls) oauthPill.classList.add(cls);
    }

    async function googleStatus() {
      try {
        const [dbgResp, tokResp] = await Promise.allSettled([
          fetch("/api/google/debug"),
          fetch("/api/google/tokens")
        ]);

        let dbg = null, tok = null;
        if (dbgResp.status === "fulfilled") dbg = await dbgResp.value.json();
        if (tokResp.status === "fulfilled") tok = await tokResp.value.json();

        const connected = tok && tok.ok && tok.exists;
        setPill(connected ? "מחובר" : "לא מחובר", connected ? "ok" : "warn");

        oauthInfo.textContent =
          (dbg ? `CLIENT_ID: ${dbg.env?.GOOGLE_CLIENT_ID}\nREDIRECT_URI: ${dbg.env?.GOOGLE_REDIRECT_URI}\nTOKENS_DIR: ${dbg.env?.TOKENS_DIR}` : "—") +
          (tok ? `\nTOKENS: ${tok.exists ? "exists" : "missing"} (${tok.path || ""})` : "");

        return { dbg, tok, connected };
      } catch (e) {
        setPill("שגיאה", "bad");
        oauthInfo.textContent = "שגיאה בבדיקת סטטוס: " + e;
        return { error: e };
      }
    }

    async function connectGoogle() {
      try {
        const r = await fetch("/api/google/oauth/url");
        const j = await r.json();
        if (!j.ok || !j.url) {
          alert("שגיאה בהפקת URL ל-Google OAuth");
          show(j, "שגיאת OAuth URL");
          return;
        }
        // הפניה למסך ההרשאות
        window.location.href = j.url;
      } catch (e) {
        alert("שגיאת רשת: " + e);
      }
    }

    function buildProposalFromInputs(base) {
      const p = { ...(base || {}) };
      // נאסוף רק אם מולאו
      if (input.fromEmail.value.trim())      p.fromEmail = input.fromEmail.value.trim();
      if (input.hours.value)                 p.hours = Number(input.hours.value);
      if (input.spreadsheetId.value.trim())  p.spreadsheetId = input.spreadsheetId.value.trim();
      if (input.tabName.value.trim())        p.tab = input.tabName.value.trim();
      if (input.limit.value)                 p.limit = Number(input.limit.value);
      if (input.newerThanDays.value)         p.newerThanDays = Number(input.newerThanDays.value);
      return p;
    }

    async function planFromText() {
      const text = input.freeText.value.trim();
      if (!text) { alert("נא להזין תיאור טקסט חופשי"); return; }

      show({ status: "⏳ שולח ל- /api/plan", text });
      hintsBox.textContent = "Hints: —";

      const body = { text };
      const r = await fetch("/api/plan", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const j = await r.json();

      // הצג תשובה
      show(j, "תכנון (plan)");
      if (j?.hints) hintsBox.textContent = "Hints: " + JSON.stringify(j.hints);

      // אם חסרים שדות — נסמן למשתמש
      if (Array.isArray(j?.missing) && j.missing.length) {
        const m = j.missing.join(", ");
        hintsBox.textContent += `\nחסרים: ${m}`;
      }

      // נשמור את התכנון האחרון בזיכרון העמוד
      window.__lastPlan = j;
    }

    function buildPipelineForRun() {
      const last = window.__lastPlan || null;
      // ברירת מחדל למקרה שאין plan: ננסה "sla-simple"
      let type = "sla-simple";
      let baseProposal = {};

      if (last && last.type) {
        // /api/plan יכול להחזיר { type: 'pipeline', proposal: {...} } או type ספציפי
        type = last.type === "pipeline" && last.proposal?.type
          ? last.proposal.type
          : last.type;
        baseProposal = last.proposal || {};
      }

      const proposal = buildProposalFromInputs(baseProposal);

      return { type, proposal };
    }

    async function dryRun() {
      const pipeline = buildPipelineForRun();
      show({ status: "⏳ Dry-Run...", pipeline });

      const r = await fetch("/api/automations/dry-run", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(pipeline)
      });
      const j = await r.json();
      show(j, "Dry-Run");
    }

    async function execute() {
      const pipeline = buildPipelineForRun();
      show({ status: "⏳ Execute...", pipeline });

      const r = await fetch("/api/automations/execute", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(pipeline)
      });
      const j = await r.json();
      show(j, "Execute");
    }

    // אירועים
    $("btnGoogle").addEventListener("click", connectGoogle);
    $("btnStatus").addEventListener("click", googleStatus);
    $("btnPlan").addEventListener("click", planFromText);
    $("btnDryRun").addEventListener("click", dryRun);
    $("btnExecute").addEventListener("click", execute);

    // אתחול מסך
    (async () => {
      await googleStatus();
      // דוגמת טקסט התחלתית
      if (!input.freeText.value) {
        input.freeText.value = "כל מייל מכתובת foo@bar.com שלא נענה במשך 4 שעות – הוסף שורה ל-Google Sheets בטאב SLA";
      }
      // אם הידעת מזהה Production, אפשר להשאיר הכל כמו שהוא — הנתיבים יחסיים.
    })();
  </script>
</body>
</html>
