<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Wizard Plus â€” Chat UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadein .4s ease; }
    @keyframes fadein { from {opacity:0; transform: translateY(6px)} to {opacity:1; transform:none} }
    .bubble{ background:#0b1323; border:1px solid #273244; color:#e5e7eb; }
    .bubble.user{ background:#121a2b; }
    .btn {
      appearance:none; border:none; border-radius:12px; padding:12px 16px;
      background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff;
      cursor:pointer; font-weight:700; letter-spacing:.3px; box-shadow:0 8px 24px rgba(99,102,241,.35);
    }
    .btn:hover{ filter:brightness(1.03); }
    .btn-ghost{ background:transparent; border:1px solid #334155; color:#e5e7eb; box-shadow:none; }
    .pill{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #334155;display:inline-flex;align-items:center;gap:6px;}
    .pill-ok{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.3); color:#0bb37b;}
    .pill-err{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35); color:#ef4444;}
    .chat-input { background:#ffffff; color:#111827; border:2px solid #e5e7eb; }
    .chat-input.missing { border-color:#ef4444; box-shadow:0 0 0 3px rgba(239,68,68,.15); }
    code { background:#0b1220; padding:2px 6px; border-radius:6px; border:1px solid #1f2937; }
    .small { font-size:12px; color:#9ca3af }
    select, input[type=text], input[type=number] {
      background:#0b1323; color:#e5e7eb; border:1px solid #273244; border-radius:10px; padding:8px 10px;
    }
    .row { display:grid; gap:8px }
    @media(min-width:800px){ .row { grid-template-columns: 1fr 1fr 1fr } }
  </style>
</head>
<body class="min-h-screen bg-gray-100 text-gray-100 flex">
  <!-- Sidebar (×¢×™×¦×•×‘ ××§×•×¨×™) -->
  <aside class="w-64 bg-white text-gray-800 shadow-lg p-6 hidden md:block">
    <h2 class="text-xl font-bold mb-6">ğŸ“‚ ×”××•×˜×•××¦×™×•×ª ×©×œ×™</h2>
    <ul class="space-y-3">
      <li class="p-3 bg-blue-100 text-blue-700 rounded-lg font-medium">××•×˜×•××¦×™×” ×—×“×©×”</li>
      <li class="p-3 hover:bg-gray-100 rounded-lg cursor-pointer">SLA ××™×™×œ×™×</li>
      <li class="p-3 hover:bg-gray-100 rounded-lg cursor-pointer">×¡×™×›×•× ×™×•××™</li>
      <li class="p-3 hover:bg-gray-100 rounded-lg cursor-pointer">×ª×‘× ×™×•×ª WhatsApp</li>
    </ul>
    <div class="mt-8">
      <p class="text-xs text-gray-400">×’×¨×¡×” 0.4 Â· Prototype</p>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-6 md:p-10">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-gray-800">âœ¨ ×¦×•×¨ ××•×˜×•××¦×™×” ×—×“×©×”</h1>
      <div class="flex items-center gap-3">
        <span id="sa-status" class="pill pill-ok">Service Account Mode</span>
        <a class="pill" href="/api/sheets/version" target="_blank">/api/sheets/version</a>
      </div>
    </header>

    <!-- Composer -->
    <section class="bg-white text-gray-800 shadow-lg rounded-2xl p-8 max-w-3xl">
      <label class="block text-sm text-gray-600 mb-2">×ª××¨ ××” ××ª×” ×¦×¨×™×š:</label>
      <textarea id="free-text"
        class="w-full h-40 border rounded-xl p-4 outline-none focus:ring-2 focus:ring-blue-300 mb-4"
        placeholder='×“×•×’××”: "×›×œ ××™×™×œ ×××©×ª××© ××¡×•×™× ×©×œ× × ×¢× ×” 4 ×©×¢×•×ª â†’ ×”×•×¡×£ ×œ×©×™×˜×¡ ×‘×˜××‘ sla ×•×’× ×©×œ×— ×•×•××˜×¡××¤ ×œ+972..."'></textarea>

      <div class="row mb-4">
        <div>
          <label class="block text-sm text-gray-600 mb-1">×¡×¤×§ NLP</label>
          <select id="provider" class="w-full">
            <option value="heuristic">heuristic (×‘×¨×™×¨×ª ××—×“×œ)</option>
            <option value="ollama">ollama</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">××•×“×œ (×›×©-Ollama)</label>
          <input id="model" type="text" class="w-full" placeholder="llama3.1:8b" value="llama3.1:8b"/>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Spreadsheet ID ×œ×‘×¨×™×¨×ª ××—×“×œ</label>
          <input id="sheetId" type="text" class="w-full" placeholder="1HoF...Nd3M" value="1HoFa5MUvMeijYYYoLl_cSW7cvhe013qsEvouuewNd3M"/>
        </div>
      </div>

      <div class="flex gap-3">
        <button id="btn-plan" class="btn">ğŸ§­ ×”×¤×§ ×ª×›× ×•×Ÿ</button>
        <button id="btn-dry" class="btn-ghost px-4 py-2 rounded-xl">ğŸ§ª Dry-Run</button>
        <button id="btn-exec" class="btn-ghost px-4 py-2 rounded-xl">ğŸš€ Execute</button>
        <button id="btn-debug-nlp" class="btn-ghost px-4 py-2 rounded-xl">ğŸ” ×‘×“×™×§×ª NLP</button>
      </div>
      <div class="small mt-2">××•××œ×¥: ×ª×›× ×•×Ÿ â†’ Dry-Run â†’ Execute. ××¤×©×¨ ×’× ×œ×”×“×‘×™×§ JSON ××œ× ×‘×ª×—×ª×™×ª.</div>
    </section>

    <!-- Chat Section -->
    <section class="mt-8 max-w-3xl">
      <div id="chat" class="space-y-3">
        <div class="fade-in flex justify-start">
          <div class="bubble rounded-2xl px-4 py-3 max-w-[80%]">
            ×›×ª×•×‘ ××˜×¨×” ×—×•×¤×©×™×ª ×•×œ×—×¥ â€œ×”×¤×§ ×ª×›× ×•×Ÿâ€. ×”××¢×¨×›×ª ×ª× ×¡×” ×œ×‘× ×•×ª <b>pipeline</b> ×¢× ×›××” ×¦×¢×“×™× (Sheets / HTTP / WhatsApp). ×× ×™×—×¡×¨ ××™×“×¢ â€” ××©××œ ×›××Ÿ ×‘×‘×•×¢×•×ª.
          </div>
        </div>
      </div>

      <div class="mt-6">
        <label class="block text-sm text-gray-300 mb-1">Pipeline JSON (× ×™×ª×Ÿ ×œ×¢×¨×™×›×” ×™×“× ×™×ª)</label>
        <textarea id="manualPipe" class="w-full h-48 bg-[#0b1323] text-gray-100 border border-[#273244] rounded-xl p-3" spellcheck="false"></textarea>
      </div>
    </section>
  </main>

  <script>
    // ---------- Config ----------
    const API_BASE = (() => {
      try {
        const loc = window.location;
        if (loc.protocol === 'file:') return 'http://127.0.0.1:5000';
        return `${loc.protocol}//${loc.host}`;
      } catch { return 'http://127.0.0.1:5000'; }
    })();

    // ---------- UI helpers ----------
    function addBubble(text, who='sys') {
      const chat = document.getElementById('chat');
      const wrap = document.createElement('div');
      wrap.className = 'fade-in flex ' + (who==='user' ? 'justify-end' : 'justify-start');
      const b = document.createElement('div');
      b.className = 'bubble rounded-2xl px-4 py-3 max-w-[80%] ' + (who==='user' ? 'user' : '');
      b.innerHTML = text;
      wrap.appendChild(b);
      chat.appendChild(wrap);
      b.scrollIntoView({ behavior:'smooth', block:'end' });
      return b;
    }
    function addInputBubble(placeholder, type='text', widthClass='w-72', markMissing=false) {
      const chat = document.getElementById('chat');
      const wrap = document.createElement('div');
      wrap.className = 'fade-in flex justify-end';
      const input = document.createElement('input');
      input.type = type;
      input.placeholder = placeholder;
      input.className = `chat-input rounded-2xl p-3 ${widthClass} shadow outline-none focus:ring-2 focus:ring-blue-300`;
      if (markMissing) input.classList.add('missing');
      wrap.appendChild(input);
      chat.appendChild(wrap);
      input.scrollIntoView({ behavior:'smooth', block:'end' });
      input.focus();
      return input;
    }
    function addButtonBubble(label, onClick, variant='primary') {
      const chat = document.getElementById('chat');
      const wrap = document.createElement('div');
      wrap.className = 'fade-in flex justify-end';
      const btn = document.createElement('button');
      btn.className = (variant==='primary' ? 'btn' : 'btn-ghost') + ' rounded-2xl';
      btn.textContent = label;
      btn.onclick = onClick;
      wrap.appendChild(btn);
      chat.appendChild(wrap);
      btn.scrollIntoView({ behavior:'smooth', block:'end' });
      return btn;
    }

    // ---------- State ----------
    let currentProposal = null;
    let currentType = null;
    let currentPipeline = null;
    const answers = { spreadsheetId: null, tab: null, fromEmail: null, hours: null, newerThanDays: null, limit: null, toPhone: null };

    function isPipelineResponse(j) {
      return j && (j.type === 'pipeline' || (j.proposal && j.proposal.type === 'pipeline') || j.pipeline);
    }

    function extractSpreadsheetId(input) {
      if (!input) return null;
      if (/^[a-zA-Z0-9-_]{20,}$/.test(input)) return input;
      const m = String(input).match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      return m ? m[1] : null;
    }

    function askMissingFields(missingList, proposal) {
      if (!missingList || !missingList.length) {
        addBubble('âœ… ×™×© ××ª ×›×œ ×”××™×“×¢. ×ª×¨×¦×” ×œ×”×¨×™×¥ Dry-Run ××• Execute?', 'sys');
        addButtonBubble('ğŸ§ª Dry-Run', dryRun, 'primary');
        addButtonBubble('ğŸš€ Execute', executePlan, 'ghost');
        return;
      }
      const next = missingList.shift();

      if (next === 'spreadsheetId') {
        addBubble('×”×“×‘×§ ×§×™×©×•×¨/ID ×©×œ Google Sheet:', 'sys');
        const input = addInputBubble('https://docs.google.com/spreadsheets/d/XXXXX/edit', 'text', 'w-[28rem]', true);
        addButtonBubble('×”××©×š', () => {
          const id = extractSpreadsheetId(input.value.trim()) || document.getElementById('sheetId').value.trim();
          if (!id) { addBubble('âŒ ×œ× ×”×¦×œ×—×ª×™ ×œ×—×œ×¥ Spreadsheet ID'); return; }
          answers.spreadsheetId = id; input.classList.remove('missing');
          addBubble(`<code>${id}</code>`, 'user');
          askMissingFields(missingList, proposal);
        });
        return;
      }

      if (next === 'tab') {
        addBubble('×©× ×”×˜××‘ ×‘×’×™×œ×™×•×Ÿ?', 'sys');
        const input = addInputBubble('sla', 'text', 'w-48', true);
        addButtonBubble('×”××©×š', () => {
          const t = input.value.trim() || 'sla';
          answers.tab = t; input.classList.remove('missing');
          addBubble(`Tab: <b>${t}</b>`, 'user');
          askMissingFields(missingList, proposal);
        });
        return;
      }

      if (next === 'toPhone') {
        addBubble('××¡×¤×¨ WhatsApp ×™×¢×“ (+972â€¦)?', 'sys');
        const input = addInputBubble('+9725XXXXXXXX', 'text', 'w-64', true);
        addButtonBubble('×”××©×š', () => {
          const p = input.value.trim().replace(/\s|-/g, '');
          if (!p) { addBubble('âŒ ×—×¡×¨ ××¡×¤×¨'); return; }
          answers.toPhone = p;
          addBubble(p, 'user');
          askMissingFields(missingList, proposal);
        });
        return;
      }

      // fallback
      addBubble(`âš ï¸ ×©×“×” × ×“×¨×©: ${next} â€” ×”×–×Ÿ ×›×¢×ª:`, 'sys');
      const input = addInputBubble('×¢×¨×š...', 'text', 'w-64', true);
      addButtonBubble('×”××©×š', () => {
        const v = input.value.trim();
        if (!v) { addBubble('âŒ ×¢×¨×š ×—×¡×¨'); return; }
        addBubble(v, 'user');
        askMissingFields(missingList, proposal);
      });
    }

    function buildPayloadForCurrent() {
      // ×× ×”×’×™×¢ pipeline ××œ× â€“ ×××œ××™× placeholders
      if (currentPipeline && currentPipeline.type === 'pipeline' && Array.isArray(currentPipeline.steps)) {
        const filled = JSON.parse(JSON.stringify(currentPipeline));
        for (const s of filled.steps) {
          if (!s.params) continue;
          for (const k of Object.keys(s.params)) {
            if (typeof s.params[k] === 'string') {
              s.params[k] = s.params[k]
                .replace(/\$\{spreadsheetId\}/g, answers.spreadsheetId || document.getElementById('sheetId').value.trim())
                .replace(/\$\{tab\}/g, answers.tab || 'sla')
                .replace(/\$\{toPhone\}/g, answers.toPhone || '');
            }
          }
        }
        return filled; // ×›×‘×¨ ×‘×¤×•×¨××˜ {steps:[...]}
      }

      // ××—×¨×ª â€“ ×× ×”×”×¦×¢×” ×¤×©×•×˜×”, × ×”×¤×•×š ××•×ª×” ×œ-pipeline ×©×œ ×¦×¢×“ ××—×“ ×œ-sheets.append
      if (currentProposal && (answers.spreadsheetId || currentProposal.spreadsheetId)) {
        const spreadsheetId = answers.spreadsheetId || currentProposal.spreadsheetId;
        const sheetName = answers.tab || currentProposal.tab || 'sla';
        return {
          steps: [
            { action: { type: "sheets.append", params: { spreadsheetId, sheetName, row: { test:"from-ui", ts: new Date().toISOString() } } } }
          ]
        };
      }

      return null;
    }

    async function planFromText() {
      const text = (document.getElementById('free-text').value || '').trim();
      if (!text) { addBubble('âŒ ×›×ª×•×‘ ××˜×¨×” ×—×•×¤×©×™×ª'); return; }
      addBubble(text, 'user');

      const provider = document.getElementById('provider').value;
      const model = document.getElementById('model').value.trim() || undefined;

      try {
        const r = await fetch(`${API_BASE}/api/plan/from-text`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text, provider, model, defaults: { spreadsheetId: document.getElementById('sheetId').value.trim() } })
        });
        const j = await r.json();
        if (!j.ok) { addBubble(`âŒ ${j.error || '×©×’×™××” ×‘Ö¾/api/plan/from-text'}`); return; }

        currentProposal = j.proposal || {};
        currentType = j.type || currentProposal.type || null;
        currentPipeline = j.pipeline || (j.proposal && j.proposal.type==='pipeline' ? j.proposal : null);

        // ××¦×™×’ JSON ×œ×¢×¨×™×›×” ×™×“× ×™×ª
        const manual = currentPipeline ? currentPipeline : (j.proposal?.steps ? { steps: j.proposal.steps } : j);
        document.getElementById('manualPipe').value = JSON.stringify(manual, null, 2);

        const missing = (j.missing || []).slice();
        if (missing.length) {
          addBubble(`× ×“×¨×©×™× ×¤×¨×˜×™× ××©×œ×™××™×: <code>${missing.join(', ')}</code>`, 'sys');
          askMissingFields(missing, currentProposal);
        } else {
          addBubble('âœ… ×ª×›× ×™×ª ××•×›× ×” â€” ×œ×”×¨×™×¥ Dry-Run ××• Execute?', 'sys');
          addButtonBubble('ğŸ§ª Dry-Run', dryRun, 'primary');
          addButtonBubble('ğŸš€ Execute', executePlan, 'ghost');
        }
      } catch (e) {
        addBubble('âŒ ×©×’×™××ª ×¨×©×ª ×‘Ö¾/api/plan/from-text');
      }
    }

    async function dryRun() {
      let payload = null;
      try { payload = JSON.parse(document.getElementById('manualPipe').value); }
      catch { payload = buildPayloadForCurrent(); }
      if (!payload || !payload.steps) { addBubble('âŒ ××™×Ÿ pipeline ×ª×§×™×Ÿ'); return; }

      try {
        const r = await fetch(`${API_BASE}/api/automations/dry-run`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        addBubble(`ğŸ§ª Dry-Run: <pre class="text-xs mt-2"><code>${JSON.stringify(j, null, 2).replace(/</g,'&lt;')}</code></pre>`, 'sys');
      } catch { addBubble('âŒ ×©×’×™××ª ×¨×©×ª ×‘-Dry-Run'); }
    }

    async function executePlan() {
      let payload = null;
      try { payload = JSON.parse(document.getElementById('manualPipe').value); }
      catch { payload = buildPayloadForCurrent(); }
      if (!payload || !payload.steps) { addBubble('âŒ ××™×Ÿ pipeline ×ª×§×™×Ÿ'); return; }

      try {
        const r = await fetch(`${API_BASE}/api/automations/execute`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        addBubble(`âœ… ×‘×•×¦×¢: <pre class="text-xs mt-2"><code>${JSON.stringify(j, null, 2).replace(/</g,'&lt;')}</code></pre>`, 'sys');
      } catch { addBubble('âŒ ×©×’×™××ª ×¨×©×ª ×‘-Execute'); }
    }

    // Events
    document.getElementById('btn-plan').onclick = planFromText;
    document.getElementById('btn-dry').onclick  = dryRun;
    document.getElementById('btn-exec').onclick = executePlan;
    document.getElementById('btn-debug-nlp').onclick = async () => {
      const text = (document.getElementById('free-text').value || '').trim();
      if (!text) { addBubble('âŒ ×›×ª×•×‘ ××˜×¨×” ×—×•×¤×©×™×ª'); return; }
      addBubble('ğŸ” ××¨×™×¥ /api/nlp/parseâ€¦', 'sys');
      try {
        const res = await fetch(`${API_BASE}/api/nlp/parse`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text })
        });
        const j = await res.json();
        addBubble(`NLP: <code>${j.intent || 'â€”'}</code> Â· Provider: <code>${j.provider || 'â€”'}</code>
          <pre class="text-xs mt-2"><code>${JSON.stringify(j, null, 2).replace(/</g,'&lt;')}</code></pre>`, 'sys');
      } catch { addBubble('âŒ ×©×’×™××ª NLP'); }
    };
  </script>
</body>
</html>
