<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Wizard Plus â€” Chat UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadein .4s ease; }
    @keyframes fadein { from {opacity:0; transform: translateY(6px)} to {opacity:1; transform:none} }
    .bubble{ background:#0b1323; border:1px solid #273244; color:#e5e7eb; }
    .bubble.user{ background:#121a2b; }
    .btn {
      appearance:none; border:none; border-radius:12px; padding:12px 16px;
      background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff;
      cursor:pointer; font-weight:700; letter-spacing:.3px; box-shadow:0 8px 24px rgba(99,102,241,.35);
    }
    .btn:hover{ filter:brightness(1.03); }
    .btn-ghost{ background:transparent; border:1px solid #334155; color:#e5e7eb; box-shadow:none; }
    .pill{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #334155;display:inline-flex;align-items:center;gap:6px;}
    .pill-ok{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.3); color:#0bb37b;}
    .pill-err{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35); color:#ef4444;}
    /* ×ª×©×•×‘×•×ª/××™× ×¤×•×˜×™× ×‘×‘×•×¢×•×ª â€“ ×¨×§×¢ ×œ×‘×Ÿ ×•×˜×§×¡×˜ ×›×”×” ×›×“×™ ×©×œ× "×™×™×¢×œ×" */
    .chat-input { background:#ffffff; color:#111827; border:1px solid #e5e7eb; }
    code { background:#0b1220; padding:2px 6px; border-radius:6px; border:1px solid #1f2937; }
  </style>
</head>
<body class="min-h-screen bg-gray-100 text-gray-100 flex">
  <!-- Sidebar -->
  <aside class="w-64 bg-white text-gray-800 shadow-lg p-6 hidden md:block">
    <h2 class="text-xl font-bold mb-6">ğŸ“‚ ×”××•×˜×•××¦×™×•×ª ×©×œ×™</h2>
    <ul class="space-y-3">
      <li class="p-3 bg-blue-100 text-blue-700 rounded-lg font-medium">××•×˜×•××¦×™×” ×—×“×©×”</li>
      <li class="p-3 hover:bg-gray-100 rounded-lg cursor-pointer">SLA ××™×™×œ×™×</li>
      <li class="p-3 hover:bg-gray-100 rounded-lg cursor-pointer">×¡×™×›×•× ×™×•××™</li>
      <li class="p-3 hover:bg-gray-100 rounded-lg cursor-pointer">×ª×‘× ×™×•×ª WhatsApp</li>
    </ul>
    <div class="mt-8">
      <p class="text-xs text-gray-400">×’×¨×¡×” 0.4 Â· Prototype</p>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-6 md:p-10">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-gray-800">âœ¨ ×¦×•×¨ ××•×˜×•××¦×™×” ×—×“×©×”</h1>
      <div class="flex items-center gap-3">
        <span id="g-status" class="pill">×˜×•×¢×Ÿâ€¦</span>
        <span id="g-email" class="text-sm text-gray-500"></span>
        <button id="btn-g-connect" class="px-4 py-2 btn">ğŸ”‘ ×”×ª×—×‘×¨ ×¢× Google</button>
        <button id="btn-g-disconnect" class="px-4 py-2 btn-ghost rounded-lg">×”×ª× ×ª×§</button>
      </div>
    </header>

    <!-- Composer -->
    <section class="bg-white text-gray-800 shadow-lg rounded-2xl p-8 max-w-3xl">
      <label class="block text-sm text-gray-600 mb-2">×ª××¨ ××” ××ª×” ×¦×¨×™×š:</label>
      <textarea id="free-text"
        class="w-full h-40 border rounded-xl p-4 outline-none focus:ring-2 focus:ring-blue-300 mb-6"
        placeholder='×“×•×’××”: "×›×œ ××™×™×œ ×©×”×’×™×¢ ×××©×ª××© ××¡×•×™× ×‘×—×•×“×© ×”××—×¨×•×Ÿ, ×•×œ× ×¢× ×™×ª×™ ×œ×• ×‘-5 ×©×¢×•×ª â€” ×ª×›× ×™×¡ ×œ×’×•×’×œ ×©×™×˜ / ×©×œ×— ×œ×™ ×‘×•×•××˜×¡××¤"'></textarea>
      <div class="flex gap-3">
        <button id="btn-create" class="btn">ğŸš€ ×¦×•×¨ ××•×˜×•××¦×™×”</button>
        <button id="btn-debug-nlp" class="btn-ghost px-4 py-2 rounded-xl">×‘×“×™×§×ª NLP</button>
      </div>
    </section>

    <!-- Chat Section -->
    <section class="mt-8 max-w-3xl">
      <div id="chat" class="space-y-3">
        <!-- ×‘×•×¢×ª ×¤×ª×™×—×” -->
        <div class="fade-in flex justify-start">
          <div class="bubble rounded-2xl px-4 py-3 max-w-[80%]">
            ×›×ª×•×‘ ××˜×¨×” ×—×•×¤×©×™×ª ×•×œ×—×¥ â€œ×¦×•×¨ ××•×˜×•××¦×™×”â€. ×× ×™ ××‘×™×Ÿ ××ª ×”×›×•×•× ×” (×œ××©×œ SLA/×œ×™×“×™×/WhatsApp)
            ×•×× ×™×—×¡×¨ ××™×“×¢ â€” ××©××œ ×›××Ÿ ×‘×‘×•×¢×•×ª. âœï¸
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // -------- Config --------
    const API_BASE = (() => {
      try {
        const loc = window.location;
        if (loc.protocol === 'file:') return 'http://127.0.0.1:5000';
        if (/:\d+$/.test(loc.host)) return `${loc.protocol}//${loc.host}`;
        return `${loc.protocol}//${loc.hostname}:5000`;
      } catch { return 'http://127.0.0.1:5000'; }
    })();

    // -------- Helpers UI --------
    function addBubble(text, who='sys') {
      const chat = document.getElementById('chat');
      const wrap = document.createElement('div');
      wrap.className = 'fade-in flex ' + (who==='user' ? 'justify-end' : 'justify-start');
      const b = document.createElement('div');
      b.className = 'bubble rounded-2xl px-4 py-3 max-w-[80%] ' + (who==='user' ? 'user' : '');
      b.innerHTML = text;
      wrap.appendChild(b);
      chat.appendChild(wrap);
      b.scrollIntoView({ behavior:'smooth', block:'end' });
      return b;
    }
    function addInputBubble(placeholder, type='text', widthClass='w-72') {
      const chat = document.getElementById('chat');
      const wrap = document.createElement('div');
      wrap.className = 'fade-in flex justify-end';
      const input = document.createElement('input');
      input.type = type;
      input.placeholder = placeholder;
      input.className = `chat-input rounded-2xl p-3 ${widthClass} shadow outline-none focus:ring-2 focus:ring-blue-300`;
      wrap.appendChild(input);
      chat.appendChild(wrap);
      input.scrollIntoView({ behavior:'smooth', block:'end' });
      input.focus();
      return input;
    }
    function addButtonBubble(label, onClick) {
      const chat = document.getElementById('chat');
      const wrap = document.createElement('div');
      wrap.className = 'fade-in flex justify-end';
      const btn = document.createElement('button');
      btn.className = 'btn rounded-2xl';
      btn.textContent = label;
      btn.onclick = onClick;
      wrap.appendChild(btn);
      chat.appendChild(wrap);
      btn.scrollIntoView({ behavior:'smooth', block:'end' });
      return btn;
    }
    function setGoogleStatus(connected, email) {
      const s = document.getElementById('g-status');
      s.textContent = connected ? '××—×•×‘×¨' : '×œ× ××—×•×‘×¨';
      s.className = 'pill ' + (connected ? 'pill-ok' : 'pill-err');
      document.getElementById('g-email').textContent = connected && email ? `(${email})` : '';
    }
    function extractSpreadsheetId(input) {
      if (!input) return null;
      if (/^[a-zA-Z0-9-_]{30,}$/.test(input)) return input;
      const m = String(input).match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      return m ? m[1] : null;
    }

    // -------- API helpers --------
    async function safeFetch(url, opts) {
      try { return await fetch(url, opts); }
      catch (e) { addBubble('âŒ ×©×’×™××ª ×¨×©×ª'); throw e; }
    }
    async function refreshGoogleAccount() {
      try {
        const r = await safeFetch(`${API_BASE}/api/google/account`, { credentials:'include' });
        const j = await r.json();
        setGoogleStatus(!!j.connected, j.email || null);
      } catch { setGoogleStatus(false, null); }
    }
    async function connectGoogle() {
      const r = await safeFetch(`${API_BASE}/api/google/auth-url`, { credentials:'include' });
      const j = await r.json();
      if (!j.ok) return addBubble(`âŒ ${j.error || '×©×’×™××” ×‘×”×¤×§×ª ×§×™×©×•×¨'}`);
      const w = window.open(j.url, 'google_auth', 'width=520,height=600');
      if (!w) addBubble('× × ×œ××¤×©×¨ ×—×œ×•× ×•×ª ×§×•×¤×¦×™× (Pop-ups).');
    }
    async function disconnectGoogle() {
      await safeFetch(`${API_BASE}/api/google/disconnect`, { method:'POST', credentials:'include' });
      await refreshGoogleAccount();
    }

    // -------- Planner / NLP --------
    let currentProposal = null;
    let currentType = null; // 'sla-simple' | 'lead-intake' | 'whatsapp-notify' | ...

    const answers = {
      spreadsheetId: null,
      tab: null,
      fromEmail: null,
      hours: null,
      keyword: null,
      limit: null,
      dateAfter: null,
      newerThanDays: null,
      toPhone: null,
      timeWindowText: null,
    };

    function askMissingFields(missingList, proposal) {
      if (!missingList || !missingList.length) {
        addBubble('âœ… ×™×© ×œ×™ ××ª ×›×œ ×”× ×ª×•× ×™×. ××•×›×Ÿ ×œ×”×¨×¦×”!');
        addButtonBubble('×”×¤×¢×œ ×¢×›×©×™×•', async () => { await executePlan(); });
        return;
      }
      const next = missingList.shift();

      if (next === 'fromEmail') {
        addBubble('××” ×›×ª×•×‘×ª ×”××™×™×œ ×©×œ ×”×©×•×œ×—?', 'sys');
        const input = addInputBubble('name@domain.com', 'email', 'w-80');
        addButtonBubble('×”××©×š', () => {
          const val = input.value.trim();
          if (!val || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(val)) { addBubble('âŒ ××™××™×™×œ ×œ× ×ª×§×™×Ÿ'); return; }
          answers.fromEmail = val;
          addBubble(val, 'user');
          askMissingFields(missingList, proposal);
        });
        return;
      }

      if (next === 'hours') {
        addBubble('××—×¨×™ ×›××” ×©×¢×•×ª × ×—×©×™×‘ ×—×¨×™×’×”?', 'sys');
        const input = addInputBubble('×œ××©×œ 15', 'number', 'w-40');
        addButtonBubble('×”××©×š', () => {
          const num = Number(input.value);
          if (!num || num <= 0) { addBubble('âŒ ××¡×¤×¨ ×©×¢×•×ª ×œ× ×ª×§×™×Ÿ'); return; }
          answers.hours = num;
          addBubble(`${num} ×©×¢×•×ª`, 'user');
          askMissingFields(missingList, proposal);
        });
        return;
      }

      if (next === 'spreadsheetId') {
        addBubble('×”×“×‘×§ ×§×™×©×•×¨ ×œ×’×™×œ×™×•×Ÿ Google Sheets (××• ID):', 'sys');
        const input = addInputBubble('https://docs.google.com/spreadsheets/d/XXXXX/edit', 'text', 'w-[28rem]');
        addButtonBubble('×”××©×š', () => {
          const raw = input.value.trim();
          const id = extractSpreadsheetId(raw);
          if (!id) { addBubble('âŒ ×œ× ×”×¦×œ×—×ª×™ ×œ×—×œ×¥ Spreadsheet ID'); return; }
          answers.spreadsheetId = id;
          addBubble(`<code>${id}</code>`, 'user');
          askMissingFields(missingList, proposal);
        });
        return;
      }

      if (next === 'tab') {
        addBubble('×©× ×”×˜××‘ (×“×£) ×‘×’×™×œ×™×•×Ÿ?', 'sys');
        const input = addInputBubble(currentType === 'sla-simple' ? 'SLA' : 'Leads', 'text', 'w-60');
        addButtonBubble('×”××©×š', () => {
          const val = input.value.trim() || (currentType === 'sla-simple' ? 'SLA' : 'Leads');
          answers.tab = val;
          addBubble(val, 'user');
          askMissingFields(missingList, proposal);
        });
        return;
      }

      if (next === 'timeWindow') {
        addBubble('×˜×•×•×— ×–××Ÿ? (×œ××©×œ: "×‘×—×•×“×© ×”××—×¨×•×Ÿ", "last 30 days", "×”×—×•×“×© ×”×–×”")', 'sys');
        const input = addInputBubble('×‘×—×•×“×© ×”××—×¨×•×Ÿ', 'text', 'w-[22rem]');
        addButtonBubble('×”××©×š', () => {
          answers.timeWindowText = input.value.trim() || '';
          addBubble(answers.timeWindowText || '×œ×œ× ×”×’×‘×œ×”', 'user');
          askMissingFields(missingList, proposal);
        });
        return;
      }

      if (next === 'keyword') {
        addBubble('××™×œ×ª ××¤×ª×— ×‘×›×•×ª×¨×ª (Subject) ×œ×œ×™×“×™×?', 'sys');
        const input = addInputBubble('×œ×™×“', 'text', 'w-60');
        addButtonBubble('×”××©×š', () => {
          const val = input.value.trim() || '×œ×™×“';
          answers.keyword = val;
          addBubble(val, 'user');
          askMissingFields(missingList, proposal);
        });
        return;
      }

      if (next === 'toPhone') {
        addBubble('×œ××™×–×” ××¡×¤×¨ ×œ×©×œ×•×— WhatsApp? (××¤×©×¨ +972...)', 'sys');
        const input = addInputBubble('+972501234567', 'text', 'w-64');
        addButtonBubble('×”××©×š', () => {
          const val = input.value.trim();
          if (!val) { addBubble('âŒ ××¡×¤×¨ ×—×¡×¨'); return; }
          answers.toPhone = val.replace(/\s|-/g,'');
          addBubble(answers.toPhone, 'user');
          askMissingFields(missingList, proposal);
        });
        return;
      }

      // fallback
      addBubble(`âš ï¸ ×©×“×” × ×“×¨×©: ${next} â€” ×”×–×Ÿ ×›×¢×ª:`, 'sys');
      const input = addInputBubble('×¢×¨×š...');
      addButtonBubble('×”××©×š', () => {
        addBubble(input.value, 'user');
        askMissingFields(missingList, proposal);
      });
    }

    // ×‘×™×¦×•×¢ ×œ×¤×™ ×ª×›× ×™×ª
    async function executePlan() {
      if (!currentProposal || !currentType) { addBubble('âŒ ××™×Ÿ ×ª×›× ×™×ª ×¤×¢×™×œ×” ×œ×”×¨×¦×”'); return; }

      if (currentType === 'whatsapp-notify') {
        addBubble(`â„¹ï¸ ×–×™×”×™×ª×™ ×©×‘×¨×¦×•× ×š ×œ×§×‘×œ ×”×ª×¨××” ×‘-WhatsApp (from: <b>${answers.fromEmail || currentProposal.fromEmail || 'â€”'}</b>, SLA: <b>${answers.hours || currentProposal.hours || 'â€”'}h</b>).`, 'sys');
        addBubble(`××™× ×˜×’×¨×¦×™×™×ª WhatsApp ×¢×“×™×™×Ÿ ×œ× ××—×•×‘×¨×ª. ××¤×©×¨:
        <br>1) ×œ×”×’×“×™×¨ WhatsApp (Twilio / Meta Cloud API).
        <br>2) ×‘×™× ×ª×™×™× ×œ×©××•×¨ ××ª ×”×”×¤×¨×•×ª ×œ-Google Sheets ××• ×œ×©×œ×•×— ×‘××™×™×œ.`, 'sys');

        addButtonBubble('×©××•×¨ ×–×× ×™×ª ×œ-Google Sheets', async () => {
          if (!answers.spreadsheetId && !currentProposal.spreadsheetId) {
            addBubble('×›×“×™ ×œ×©××•×¨ ×œ-Sheets ×¦×¨×™×š ×œ×ª×ª ×§×™×©×•×¨ ×œ×’×™×œ×™×•×Ÿ.', 'sys');
            askMissingFields(['spreadsheetId','tab'], currentProposal);
            return;
          }
          currentType = 'sla-simple';
          await executePlan();
        });
        return;
      }

      let body;
      if (currentType === 'sla-simple') {
        const fromEmail = answers.fromEmail || currentProposal.fromEmail;
        const hours = answers.hours || currentProposal.hours || 4;
        const spreadsheetId = answers.spreadsheetId || currentProposal.spreadsheetId;
        const tab = answers.tab || currentProposal.tab || 'SLA';
        const dateAfter = answers.dateAfter || currentProposal.dateAfter || null;
        const newerThanDays = answers.newerThanDays || currentProposal.newerThanDays || null;
        if (!fromEmail || !hours || !spreadsheetId) { addBubble('âŒ ×—×¡×¨×™× ×¤×¨×˜×™× (fromEmail/hours/spreadsheetId)'); return; }
        body = { type: 'sla-simple', proposal: { fromEmail, hours, spreadsheetId, tab, limit: 100, dateAfter, newerThanDays } };
      } else {
        // lead-intake
        const spreadsheetId = answers.spreadsheetId || currentProposal.spreadsheetId;
        const tab = answers.tab || currentProposal.tab || 'Leads';
        const keyword = answers.keyword || currentProposal.keyword || '×œ×™×“';
        const needsQuotes = /[\s×-×ª]/.test(keyword);
        const kw = needsQuotes ? `"${keyword}"` : keyword;
        const q = `in:anywhere (subject:${kw} OR subject:Lead) -in:chats`;
        if (!spreadsheetId) { addBubble('âŒ ×—×¡×¨ spreadsheetId'); return; }
        body = { type:'lead-intake', proposal: { q, spreadsheetId, tab, limit: 30 } };
      }

      addBubble('â³ ××¨×™×¥â€¦', 'sys');
      try {
        const r = await safeFetch(`${API_BASE}/api/automations/execute`, {
          method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if (!j.ok) {
          addBubble(`âŒ ${j.message || j.error || '×©×’×™××” ×‘×”×¨×¦×”'}`);
          return;
        }
        if (currentType === 'sla-simple') {
          addBubble(`âœ… ×‘×•×¦×¢! × ×‘×“×§×• ${j.checked}, × ××¦××• ${j.matched} ×©×¢×‘×¨×• ${j.hours} ×©×¢×•×ª, × ×•×¡×¤×• ${j.appended} ×œ-Sheets.`);
        } else {
          addBubble(`âœ… ×‘×•×¦×¢! × ×‘×“×§×• ${j.checked}, ×—×“×©×™× ${j.newItems}, × ×•×¡×¤×• ${j.appended}.`);
        }
      } catch { addBubble('âŒ ×©×’×™××ª ×¨×©×ª/×©×¨×ª'); }
    }

    // -------- Events --------
    document.getElementById('btn-g-connect').onclick = connectGoogle;
    document.getElementById('btn-g-disconnect').onclick = disconnectGoogle;

    // ×™×¦×™×¨×ª ××•×˜×•××¦×™×” (Plan)
    document.getElementById('btn-create').onclick = async () => {
      const text = (document.getElementById('free-text').value || '').trim();
      if (!text) { addBubble('âŒ ×›×ª×•×‘ ××˜×¨×” ×—×•×¤×©×™×ª ×‘×ª×™×‘×” ×œ××¢×œ×”'); return; }
      addBubble(text, 'user');

      try {
        const r = await safeFetch(`${API_BASE}/api/plan`, {
          method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify({ text })
        });
        const j = await r.json();
        if (!j.ok) { addBubble(`âŒ ${j.error || '×©×’×™××”'}`); return; }

        currentProposal = j.proposal || {};
        currentType = j.type || currentProposal.type || null;

        Object.assign(answers, {
          spreadsheetId: currentProposal.spreadsheetId || null,
          tab: currentProposal.tab || null,
          fromEmail: currentProposal.fromEmail || null,
          hours: currentProposal.hours || null,
          keyword: currentProposal.keyword || null,
          dateAfter: currentProposal.dateAfter || null,
          newerThanDays: currentProposal.newerThanDays || null,
          toPhone: currentProposal.toPhone || null,
        });

        if (!currentType) {
          addBubble('â“ ×œ× ×–×™×”×™×ª×™ ×›×•×•× ×”. ××¤×©×¨ ×œ×›×ª×•×‘ "SLA", "×œ×™×“×™×/Lead", ××• "×©×œ×— ×œ×™ ×‘×•×•××˜×¡××¤".');
          return;
        }

        addBubble(`ğŸ§  ×–×™×”×™×ª×™ ×›×•×•× ×”: <b>${currentType}</b>. × ×©×œ×™× ×¤×¨×˜×™× ×—×¡×¨×™×.`);
        let missing = (j.missing || []).slice();
        if (currentType === 'whatsapp-notify' && !answers.toPhone && !missing.includes('toPhone')) {
          missing.unshift('toPhone');
        }
        askMissingFields(missing, currentProposal);
      } catch { addBubble('âŒ ×©×’×™××ª ×¨×©×ª'); }
    };

    // ×›×¤×ª×•×¨ ×‘×“×™×§×ª NLP (×œ× ×—×•×‘×” ×œ×”×¨×¦×”; ×œ×¦×•×¨×š ×“×™×‘××’)
    document.getElementById('btn-debug-nlp').onclick = async () => {
      const text = (document.getElementById('free-text').value || '').trim();
      if (!text) { addBubble('âŒ ×›×ª×•×‘ ××˜×¨×” ×—×•×¤×©×™×ª ×‘×ª×™×‘×” ×œ××¢×œ×”'); return; }
      addBubble('ğŸ” ××¨×™×¥ /api/nlp/parseâ€¦');

      try {
        const res = await safeFetch(`${API_BASE}/api/nlp/parse`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text })
        });
        const j = await res.json();
        const pretty = `<pre class="text-xs mt-2"><code>${JSON.stringify(j, null, 2)
          .replace(/</g,'&lt;').replace(/>/g,'&gt;')}</code></pre>`;
        addBubble(`NLP: <code>${j.intent || 'â€”'}</code> Â· Provider: <code>${j.provider || 'â€”'}</code>${pretty}`);
      } catch {
        addBubble('âŒ ×©×’×™××ª NLP');
      }
    };

    // init
    refreshGoogleAccount();
  </script>
</body>
</html>
